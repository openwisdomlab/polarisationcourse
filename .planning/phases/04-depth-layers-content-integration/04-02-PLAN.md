---
phase: 04-depth-layers-content-integration
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/odyssey-world/depth/DepthPanel.tsx
  - src/components/odyssey-world/depth/DepthPanelContent.tsx
  - src/components/odyssey-world/depth/ConceptTooltip.tsx
  - src/components/odyssey-world/depth/QualitativeLayer.tsx
  - src/components/odyssey-world/depth/QuantitativeLayer.tsx
  - src/components/odyssey-world/OdysseyWorld.tsx
  - src/components/odyssey-world/OpticalElement.tsx
  - src/components/odyssey-world/LightSource.tsx
autonomous: true
requirements: [VISL-05, DISC-03]

must_haves:
  truths:
    - "Hovering over a discovered concept's optical element shows a tooltip with 'Learn more' / '深入了解'"
    - "Clicking the tooltip opens a right-side panel sliding in with spring animation (~0.6-1.0s)"
    - "The world remains visible but dimmed/blurred behind the panel"
    - "Panel shows qualitative content (SVG diagrams + explanation) by default, with tab to switch to quantitative (formulas)"
    - "Pressing Escape, clicking close button, or clicking dimmed backdrop closes the panel"
    - "Panel content scrolls if it exceeds viewport height"
  artifacts:
    - path: "src/components/odyssey-world/depth/DepthPanel.tsx"
      provides: "Main panel overlay with backdrop blur, slide-in animation, close interactions"
      min_lines: 60
    - path: "src/components/odyssey-world/depth/DepthPanelContent.tsx"
      provides: "Tab navigation between qualitative/quantitative/demo layers"
      min_lines: 40
    - path: "src/components/odyssey-world/depth/ConceptTooltip.tsx"
      provides: "Hover tooltip positioned near scene elements"
      min_lines: 30
    - path: "src/components/odyssey-world/depth/QualitativeLayer.tsx"
      provides: "SVG diagrams with micro-animations and explanatory text"
      min_lines: 40
    - path: "src/components/odyssey-world/depth/QuantitativeLayer.tsx"
      provides: "KaTeX formula rendering with labels"
      min_lines: 30
  key_links:
    - from: "src/components/odyssey-world/depth/DepthPanel.tsx"
      to: "src/stores/odysseyWorldStore.ts"
      via: "reads depthPanelConceptId, calls closeDepthPanel"
      pattern: "useOdysseyWorldStore.*depthPanelConceptId"
    - from: "src/components/odyssey-world/depth/ConceptTooltip.tsx"
      to: "src/stores/odysseyWorldStore.ts"
      via: "reads tooltipConceptId/position, calls openDepthPanel on click"
      pattern: "useOdysseyWorldStore.*tooltipConceptId"
    - from: "src/components/odyssey-world/OpticalElement.tsx"
      to: "src/components/odyssey-world/concepts/conceptRegistry.ts"
      via: "getConceptForElement on hover to show tooltip"
      pattern: "getConceptForElement"
    - from: "src/components/odyssey-world/depth/QuantitativeLayer.tsx"
      to: "katex"
      via: "MathRenderer component for LaTeX formulas"
      pattern: "MathRenderer"
    - from: "src/components/odyssey-world/OdysseyWorld.tsx"
      to: "src/components/odyssey-world/depth/DepthPanel.tsx"
      via: "Rendered as sibling to SVG scene at top level"
      pattern: "DepthPanel"
---

<objective>
Build the depth panel overlay system with tooltip triggers and three-layer content rendering.

Purpose: Creates the visual transition from the isometric world into deeper content layers (VISL-05). Students hover over discovered elements to see tooltips, click to open a right-side panel with qualitative explanations and quantitative formulas (DISC-03). The panel feels like a natural extension of the world, not a page navigation.

Output: DepthPanel slide-in overlay, ConceptTooltip hover trigger, QualitativeLayer and QuantitativeLayer content renderers, wired into OdysseyWorld and OpticalElement
</objective>

<execution_context>
@/Users/jili/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jili/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-depth-layers-content-integration/04-CONTEXT.md
@.planning/phases/04-depth-layers-content-integration/04-RESEARCH.md
@.planning/phases/04-depth-layers-content-integration/04-01-SUMMARY.md
@src/stores/odysseyWorldStore.ts
@src/components/odyssey-world/OdysseyWorld.tsx
@src/components/odyssey-world/OpticalElement.tsx
@src/components/odyssey-world/LightSource.tsx
@src/components/odyssey-world/EnvironmentPopup.tsx
@src/components/odyssey-world/WorldMap.tsx
@src/components/MathRenderer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DepthPanel overlay with ConceptTooltip trigger</name>
  <files>
    src/components/odyssey-world/depth/DepthPanel.tsx
    src/components/odyssey-world/depth/DepthPanelContent.tsx
    src/components/odyssey-world/depth/ConceptTooltip.tsx
    src/components/odyssey-world/OdysseyWorld.tsx
    src/components/odyssey-world/OpticalElement.tsx
    src/components/odyssey-world/LightSource.tsx
  </files>
  <action>
**DepthPanel.tsx** -- Main overlay component (HTML, not SVG):
- Read depthPanelConceptId from store. If null, render nothing.
- Use AnimatePresence wrapping two elements:
  1. **Backdrop**: fixed inset-0 z-30, bg-black/40 with backdrop-blur-sm. onClick calls closeDepthPanel(). Animates opacity 0->1->0.
  2. **Panel**: fixed right-0 top-0 bottom-0 z-40, w-[65vw] (within 60-70% target). Slides in from right: initial={{ x: '100%' }} animate={{ x: 0 }} exit={{ x: '100%' }}. Spring transition: stiffness 120, damping 20 (research-validated ~0.7s settle time). Background: semi-transparent dark with backdrop blur (rgba(20,20,30,0.92), backdropFilter: blur(12px)). overflow-y-auto for scrollable content.
  3. **Close button**: absolute top-4 right-4, X icon from lucide-react, onClick closeDepthPanel.
- Escape key handler: useEffect with keydown listener when panel is open.
- Look up concept from conceptRegistry using depthPanelConceptId via getConceptById.
- Render DepthPanelContent with the concept.

**DepthPanelContent.tsx** -- Tab navigation and content:
- Props: concept: ConceptDefinition
- Header: concept name (via useTranslation(concept.nameKey)), intuition summary below as a brief intro paragraph (not a tab -- the intuition layer is always visible at the top per CONT-03 "experience first" philosophy).
- Tab bar with 2-3 tabs: "理解 / Understanding" (qualitative), "数学 / Mathematics" (quantitative), and optionally "探索 / Explore" (demo) if concept.demoComponentId exists.
- Tab switching uses store's setDepthPanelTab. Active tab reads from store's depthPanelActiveTab.
- Render QualitativeLayer or QuantitativeLayer based on active tab.
- Demo tab renders a placeholder for now (Plan 03 will implement DemoLayer).
- Use Framer Motion layout animation or simple opacity transition between tabs.

**ConceptTooltip.tsx** -- Hover tooltip positioned near scene elements:
- Read tooltipConceptId, tooltipPosition from store. If null, render nothing.
- Look up concept name via getConceptById + useTranslation.
- Render a small floating tooltip (fixed position at tooltipPosition.x, tooltipPosition.y offset upward by ~40px).
- Content: concept name + "深入了解" / "Learn more" text (bilingual via i18n).
- onClick: call openDepthPanel(conceptId) then hideConceptTooltip().
- Style: small rounded card with semi-transparent dark background, white text, subtle shadow. pointer-events: auto.
- AnimatePresence for smooth show/hide with scale+opacity animation.

**Wire into OdysseyWorld.tsx**:
- Import and render DepthPanel as a sibling to the existing WorldMap overlay (after the SVG scene).
- Import and render ConceptTooltip similarly.
- Both are HTML overlays at the top level of OdysseyWorld, NOT inside the SVG.

**Wire into OpticalElement.tsx and LightSource.tsx**:
- Add onMouseEnter/onMouseLeave handlers that check:
  1. Is there a concept linked to this element? (getConceptForElement with element.type and current regionId)
  2. Is the linked concept's discovery achieved? (check allTimeDiscoveries.has(concept.discoveryId))
  3. If yes to both: call showConceptTooltip(concept.id, screenX, screenY) on enter, hideConceptTooltip() on leave.
- Calculate screen position using the element's world coordinates + worldToScreenWithCamera (same pattern as EnvironmentPopup positioning).
- Do NOT show tooltip during drag/rotate interactions (check interactionMode).
- For LightSource.tsx, apply the same pattern -- the light source element can trigger concepts like "polarized emission" if defined.

**z-index hierarchy** (IMPORTANT per research pitfall 3):
- HUD: z-10 (existing)
- ConceptTooltip: z-20
- Depth panel backdrop: z-30
- Depth panel: z-40
- WorldMap: z-40 (but WorldMap and DepthPanel never coexist open -- close WorldMap if depth panel opens and vice versa)

Ensure KaTeX CSS is imported. Check main.tsx -- if 'katex/dist/katex.min.css' is not already imported, add the import.
  </action>
  <verify>pnpm run build -- no TypeScript errors. Open http://localhost:5173/odyssey/ in dev server, navigate to Crystal Lab, achieve a discovery (rotate a polarizer), then hover over the polarizer -- tooltip should appear. Click tooltip -- panel should slide in from right with qualitative content.</verify>
  <done>DepthPanel slides in from right with spring animation. Tooltip appears on hover over discovered element. Panel shows concept name, intuition intro, qualitative tab with explanation text. Quantitative tab shows LaTeX formulas via KaTeX. Escape/close/backdrop all dismiss panel. World visible but dimmed behind panel.</done>
</task>

<task type="auto">
  <name>Task 2: Implement QualitativeLayer and QuantitativeLayer content renderers</name>
  <files>
    src/components/odyssey-world/depth/QualitativeLayer.tsx
    src/components/odyssey-world/depth/QuantitativeLayer.tsx
  </files>
  <action>
**QualitativeLayer.tsx** -- SVG diagrams with explanations:
- Props: concept: ConceptDefinition
- Render the qualitative explanation text from i18n (concept.qualitative.contentKey) via useTranslation.
- For the SVG diagram: render an inline SVG diagram based on concept.qualitative.diagramComponent. For initial implementation, create simple but informative SVG diagrams inline:
  - For Malus's Law: SVG showing polarizer with transmission axis, incoming wave arrows, and transmitted intensity diminishing with angle. Use the world's color palette (dark backgrounds, light strokes matching the isometric aesthetic).
  - For Circular Polarization: SVG showing linear -> quarter-wave plate -> circular path. Use HSL encoding colors consistent with the beam visualization.
  - For Brewster's Angle: SVG showing reflected and refracted beams at an interface with the Brewster angle marked.
- Diagrams should be ~300-500px wide, fitting within the panel's content area.
- Apply subtle Framer Motion animation on diagram elements where concept.qualitative.animationHints specifies targets (e.g. the rotating electric field vector for circular polarization). Keep animations subtle -- opacity fades, gentle rotations, not flashy.
- Text content styled with Tailwind: prose-like layout, text-white/80, leading-relaxed, space-y-4 between paragraphs.
- Include a "亲自试试" / "Try it yourself" link at the bottom if concept.demoComponentId exists. This link switches to the demo tab (calls setDepthPanelTab('demo')). Style as a subtle button/link, not prominent.

**QuantitativeLayer.tsx** -- LaTeX formula rendering:
- Props: concept: ConceptDefinition
- Render the quantitative explanation text from i18n (concept.quantitative.contentKey) as introductory context.
- For each formula in concept.quantitative.formulas:
  - Render the formula label (via i18n formula.labelKey) as a small header.
  - Render the LaTeX formula using the existing MathRenderer component with displayMode={true}.
  - Wrap each formula in a rounded card (bg-white/5, px-4 py-3) for visual separation.
- If concept.quantitative.derivationStepsKey exists, render derivation steps below the main formulas as a collapsible section (click to expand). Use a simple useState toggle, not a heavy accordion library.
- Ensure katex/dist/katex.min.css is imported (verify it's in the component or in main.tsx).
- Style: mathematical content centered, good spacing between formulas, labels in smaller text above each formula.
  </action>
  <verify>pnpm run build -- no TypeScript errors. In dev mode, open a concept's depth panel, verify qualitative tab shows SVG diagram + explanation text. Switch to quantitative tab -- LaTeX formulas render correctly with proper mathematical notation (fractions, Greek letters, subscripts).</verify>
  <done>QualitativeLayer renders SVG diagrams with subtle animations and explanatory text. QuantitativeLayer renders KaTeX formulas with labels in styled cards. Both layers use bilingual content from i18n. "Try it yourself" link appears for concepts with demos.</done>
</task>

</tasks>

<verification>
1. `pnpm run build` succeeds with zero errors
2. Hovering over a polarizer in Crystal Lab (after achieving Malus's Law discovery) shows "深入了解" / "Learn more" tooltip
3. Clicking tooltip slides in depth panel from right with spring animation (~0.7s)
4. World is dimmed/blurred behind the panel (bg-black/40 + backdrop-blur-sm)
5. Panel header shows concept name + intuition summary
6. Qualitative tab (default) shows SVG diagram + physics explanation
7. Quantitative tab shows KaTeX-rendered formulas (I = I_0 cos^2 theta renders correctly)
8. Escape key, close button (X), and backdrop click all close the panel
9. Panel content scrolls when exceeding viewport height
10. No tooltip appears on undiscovered concepts (invisible gating)
11. No z-index conflicts between tooltip, depth panel, HUD, and WorldMap
</verification>

<success_criteria>
- Depth panel slides in from right, occupying ~65vw
- Three exit methods (Escape, close button, backdrop click) all work
- Qualitative layer shows SVG diagram + i18n explanation
- Quantitative layer shows properly rendered KaTeX formulas
- Tooltip appears only for discovered concepts
- Spring animation timing ~0.6-1.0s
- Panel integrates cleanly with existing world (no layout disruption)
</success_criteria>

<output>
After completion, create `.planning/phases/04-depth-layers-content-integration/04-02-SUMMARY.md`
</output>
