---
phase: 04-depth-layers-content-integration
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/components/odyssey-world/demos/MalusLawExplorer.tsx
  - src/components/odyssey-world/demos/CircularPolExplorer.tsx
  - src/components/odyssey-world/demos/BrewsterExplorer.tsx
  - src/components/odyssey-world/depth/DemoLayer.tsx
  - src/components/odyssey-world/depth/hooks/useDemoSync.ts
  - src/components/odyssey-world/depth/DepthPanelContent.tsx
  - src/components/odyssey-world/WorldMap.tsx
  - src/components/odyssey-world/hooks/useWorldMap.ts
  - src/components/odyssey-world/OdysseyWorld.tsx
autonomous: true
requirements: [CONT-02, CONT-04]

must_haves:
  truths:
    - "Student can access redesigned interactive demos from within the depth panel via 'Try it yourself' links"
    - "Adjusting a parameter in a demo (e.g. polarizer angle slider) updates the corresponding element in the isometric world scene"
    - "A concept constellation map visualizes discovered concepts overlaid on the world map with categorized connection lines"
    - "Clicking a concept node in the constellation map opens the depth panel for that concept"
    - "Demo achievements count toward the global discovery system"
  artifacts:
    - path: "src/components/odyssey-world/demos/MalusLawExplorer.tsx"
      provides: "Compact Malus's Law interactive demo for depth panel"
      min_lines: 60
    - path: "src/components/odyssey-world/demos/BrewsterExplorer.tsx"
      provides: "Brewster angle interactive demo for depth panel"
      min_lines: 50
    - path: "src/components/odyssey-world/depth/DemoLayer.tsx"
      provides: "Demo container with lazy loading and sync wiring"
      min_lines: 30
    - path: "src/components/odyssey-world/depth/hooks/useDemoSync.ts"
      provides: "Bidirectional demo-world state sync hook"
      exports: ["useDemoSync"]
    - path: "src/components/odyssey-world/WorldMap.tsx"
      provides: "Extended with concept constellation nodes and categorized connection lines"
      contains: "concept-node"
  key_links:
    - from: "src/components/odyssey-world/depth/hooks/useDemoSync.ts"
      to: "src/stores/odysseyWorldStore.ts"
      via: "reads element state, writes property updates on demo parameter change"
      pattern: "updateElement.*properties"
    - from: "src/components/odyssey-world/demos/MalusLawExplorer.tsx"
      to: "src/components/odyssey-world/depth/hooks/useDemoSync.ts"
      via: "useDemoSync hook for angle slider -> world element rotation"
      pattern: "useDemoSync|syncToWorld"
    - from: "src/components/odyssey-world/WorldMap.tsx"
      to: "src/components/odyssey-world/concepts/conceptRegistry.ts"
      via: "getConceptsForRegion to overlay concept nodes on region shapes"
      pattern: "getConceptsForRegion"
    - from: "src/components/odyssey-world/WorldMap.tsx"
      to: "src/stores/odysseyWorldStore.ts"
      via: "openDepthPanel on concept node click"
      pattern: "openDepthPanel"
---

<objective>
Build embedded demo explorers with bidirectional world sync and extend the world map into a concept constellation visualization.

Purpose: Students who want hands-on experimentation can access redesigned interactive demos within the depth panel (CONT-02). Demo parameter changes reflect back to the world scene via bidirectional sync. The concept constellation map (CONT-04) extends the existing WorldMap overlay with concept nodes and categorized connections, creating a unified spatial + conceptual navigation tool.

Output: 3 lightweight demo explorer components, bidirectional sync hook, DemoLayer container, extended WorldMap with constellation nodes
</objective>

<execution_context>
@/Users/jili/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jili/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-depth-layers-content-integration/04-CONTEXT.md
@.planning/phases/04-depth-layers-content-integration/04-RESEARCH.md
@.planning/phases/04-depth-layers-content-integration/04-01-SUMMARY.md
@.planning/phases/04-depth-layers-content-integration/04-02-SUMMARY.md
@src/stores/odysseyWorldStore.ts
@src/components/odyssey-world/WorldMap.tsx
@src/components/odyssey-world/hooks/useWorldMap.ts
@src/components/odyssey-world/OdysseyWorld.tsx
@src/components/odyssey-world/depth/DepthPanelContent.tsx
@src/components/odyssey-world/concepts/conceptRegistry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build demo explorer components with bidirectional sync</name>
  <files>
    src/components/odyssey-world/demos/MalusLawExplorer.tsx
    src/components/odyssey-world/demos/CircularPolExplorer.tsx
    src/components/odyssey-world/demos/BrewsterExplorer.tsx
    src/components/odyssey-world/depth/DemoLayer.tsx
    src/components/odyssey-world/depth/hooks/useDemoSync.ts
    src/components/odyssey-world/depth/DepthPanelContent.tsx
  </files>
  <action>
**useDemoSync.ts** -- Bidirectional sync hook:
- Takes elementId (string) and optional elementType (SceneElementType) as parameters.
- Reads the element's current state from odysseyWorldStore (properties, rotation).
- Provides syncToWorld(property: string, value: number) function that:
  1. Calls updateElement with the property change.
  2. If property is 'transmissionAxis' or 'fastAxis', also updates rotation to match (same pattern as useElementRotation).
  3. Throttles updates to max every 200ms using useRef for a throttle timer (matching existing discovery check throttle per research pitfall 2).
- Provides worldState (element.properties) and worldRotation (element.rotation) for demo to read as initial/current values.
- Uses useRef for intermediate slider values during rapid drag; only commits to store on throttled intervals or on pointerUp.
- IMPORTANT: Demo should read element properties from a direct selector, NOT subscribe to beamSegments (avoids feedback loop per research pitfall 2).

**DemoLayer.tsx** -- Demo container with lazy loading:
- Props: concept: ConceptDefinition
- Maps concept.demoComponentId to the actual React component using a lazy-load registry:
  - 'malus-law-explorer' -> React.lazy(() => import('../demos/MalusLawExplorer'))
  - 'circular-pol-explorer' -> React.lazy(() => import('../demos/CircularPolExplorer'))
  - 'brewster-explorer' -> React.lazy(() => import('../demos/BrewsterExplorer'))
- Wraps in Suspense with a loading skeleton (simple animated gradient placeholder).
- If demoComponentId is undefined or unmapped, renders a "Demo coming soon" placeholder.
- Passes conceptId and regionId to the demo component.

**MalusLawExplorer.tsx** -- Compact Malus's Law interactive:
- SVG-based visualization (NOT Canvas/WebGL, matching world's 2D-primary approach).
- Shows: incoming polarized light arrow, a polarizer element (rotatable), transmitted light arrow with intensity proportional to cos^2(angle).
- Interactive: angle slider (0-360 degrees) controlling the polarizer transmission axis. The slider value drives the SVG visualization AND syncs to the world via useDemoSync.
- Real-time intensity curve: small inline SVG plot showing I/I0 = cos^2(theta) with a moving dot at current angle. Plot dimensions ~300x150px.
- Find the appropriate scene element to sync with: search for a 'polarizer' type element in the current region's sceneElements. Use the first polarizer found. If no polarizer exists, demo runs standalone without sync.
- useDemoSync connects slider angle changes to the world's polarizer rotation.
- Physics calculation: use the PolarizationPhysics engine (import from existing physics code) for accurate Mueller matrix calculation. Share the physics engine, NOT the demo presentation layer.
- Style: dark background matching depth panel, white/light strokes for SVG, accent colors from region palette.

**CircularPolExplorer.tsx** -- Circular polarization interactive:
- Shows: linear polarized beam entering a quarter-wave plate, output beam with elliptical/circular polarization visualization.
- Interactive: QWP fast axis angle slider (0-180 degrees). At 45 degrees, output becomes circular.
- SVG visualization: the output polarization ellipse rotates/morphs as the slider changes. At 0 degrees: linear (flat line), at 45 degrees: circle, at other angles: ellipse.
- Sync with world via useDemoSync targeting a 'waveplate' element if one exists.
- Simpler than MalusLawExplorer -- focus on the polarization state visualization.

**BrewsterExplorer.tsx** -- Brewster angle interactive:
- Shows: light ray hitting an interface at variable incidence angle, reflected ray and refracted ray.
- Interactive: incidence angle slider (0-90 degrees). At Brewster angle (arctan(n2/n1)), reflected light intensity drops to zero for p-polarized component.
- SVG visualization: interface line, incident/reflected/refracted rays with thickness proportional to intensity, Brewster angle marked.
- Read refractive index from the store's environment element or use a default (n=1.5).
- Sync with world via useDemoSync if a relevant element exists.

**Update DepthPanelContent.tsx**:
- Replace the demo tab placeholder with the actual DemoLayer component.
- The "Explore" / "探索" tab renders DemoLayer with the active concept.

IMPORTANT: Do NOT import from existing DemoLayout, DemoControls, DemoHeader, ControlPanel, ChartPanel -- those are full-page demo infrastructure. Build lightweight SVG-only explorers designed for the panel width (~65vw minus padding). Keep each explorer under 150 lines.
  </action>
  <verify>pnpm run build -- no TypeScript errors. In dev mode, open Crystal Lab, discover Malus's Law, open depth panel, switch to demo tab. The MalusLawExplorer should render with a working angle slider. Dragging the slider should update the intensity visualization AND rotate the polarizer in the isometric scene behind the dimmed panel.</verify>
  <done>Three demo explorers render within the depth panel's demo tab. MalusLawExplorer slider syncs polarizer rotation to the world scene bidirectionally (throttled 200ms). All demos are SVG-based, lightweight, and match the dark panel aesthetic. DemoLayer lazy-loads the correct explorer based on concept.demoComponentId.</done>
</task>

<task type="auto">
  <name>Task 2: Extend WorldMap into concept constellation visualization</name>
  <files>
    src/components/odyssey-world/WorldMap.tsx
    src/components/odyssey-world/hooks/useWorldMap.ts
    src/components/odyssey-world/OdysseyWorld.tsx
  </files>
  <action>
**Extend WorldMap.tsx** with concept constellation overlay:
- After the existing region shapes and discovery connection lines, add a concept node layer:
  1. For each region, call getConceptsForRegion(regionId) to get concepts.
  2. For each concept, check if its discoveryId is in allTimeDiscoveries. Only render discovered concepts (invisible gating per research recommendation).
  3. Render each discovered concept as a small colored dot (SVG circle, r=4-6px) positioned within the region's shape area on the map. Position concepts in a grid or cluster layout within the region rectangle to avoid overlap. Dot fill color matches the region's accent/highlight color.
  4. On hover, show the concept name as a small tooltip label (SVG text or HTML tooltip) near the dot. Keep it minimal -- no complex popups.
  5. On click, call openDepthPanel(concept.id) AND close the WorldMap (call closeWorldMap or toggleWorldMap). This creates the dual interaction: click node -> depth panel opens.

- Add categorized connection lines between related concepts:
  1. Read concept.connections for each discovered concept.
  2. If both the source concept AND the target concept are discovered, draw a connection line between them.
  3. Style connection lines by relationship type per CONTEXT.md:
     - 'causal': solid line, warm color (amber/gold)
     - 'analogous': dashed line, cool color (blue/cyan)
     - 'contrasting': dotted line, contrasting color (rose/red)
  4. Lines should be thin (stroke-width 1-1.5), semi-transparent (opacity 0.4-0.6), and connect the concept dots across regions.
  5. Lines render BEHIND concept dots but ABOVE region shapes.

- Maintain the existing WorldMap functionality intact: region rectangles, fast-travel on click, discovery count badges, constellation glow lines from Phase 3.

**Extend useWorldMap.ts** (if needed):
- Close depth panel when WorldMap opens (mutual exclusivity with depth panel at same z-level).
- Close WorldMap when depth panel opens. Add a store subscription or effect in OdysseyWorld.tsx: if depthPanelConceptId becomes non-null and worldMap is open, close worldMap. If worldMap opens and depth panel is open, close depth panel.

**Update OdysseyWorld.tsx** (if needed):
- Ensure mutual exclusivity between WorldMap and DepthPanel. When one opens, the other closes. This can be handled by:
  - openDepthPanel action also calls the equivalent of closeWorldMap.
  - openWorldMap (toggle) also calls closeDepthPanel.
  - Or: add effects in OdysseyWorld.tsx that watch both states.

Keep the constellation map clean and readable per research pitfall 6:
- Only show discovered concepts (progressive density)
- Small dots (4-6px radius) with labels on hover only (not permanent text)
- Connection lines are subtle (thin, semi-transparent)
- Don't overwhelm the existing region layout

The constellation map position for each concept should be deterministic -- compute a fixed offset within each region's rectangle based on the concept's index within its region. No force-directed layout.
  </action>
  <verify>pnpm run build -- no TypeScript errors. In dev mode, open WorldMap (M key), verify discovered concept dots appear within their region rectangles. Hover a dot -- concept name appears. Click a dot -- WorldMap closes and depth panel opens for that concept. Connection lines visible between related discovered concepts with correct styling (solid/dashed/dotted by type).</verify>
  <done>WorldMap shows discovered concept nodes as colored dots within region shapes. Hovering a node shows concept name. Clicking a node opens the depth panel. Categorized connection lines (causal=solid/amber, analogous=dashed/blue, contrasting=dotted/rose) link related concepts across regions. WorldMap and DepthPanel are mutually exclusive. Existing WorldMap functionality (fast-travel, region discovery counts) preserved.</done>
</task>

</tasks>

<verification>
1. `pnpm run build` succeeds with zero errors
2. MalusLawExplorer renders in depth panel demo tab with working angle slider
3. Slider drag in MalusLawExplorer updates polarizer rotation in the isometric scene (bidirectional sync)
4. CircularPolExplorer shows polarization ellipse morphing with QWP angle
5. BrewsterExplorer shows reflected/refracted rays with Brewster angle minimum
6. WorldMap constellation shows discovered concept dots within region shapes
7. Hovering a concept dot shows concept name tooltip
8. Clicking a concept dot closes WorldMap and opens depth panel for that concept
9. Connection lines between discovered concepts use categorized styling (solid/dashed/dotted)
10. WorldMap and DepthPanel are mutually exclusive (opening one closes the other)
11. No performance degradation with demos active (throttled sync, no feedback loops)
</verification>

<success_criteria>
- 3 lightweight demo explorers embedded in depth panel
- Bidirectional demo-world sync working (slider -> world element rotation)
- Concept constellation map overlaid on WorldMap with discovered nodes
- Categorized connection lines visible between related concepts
- Click constellation node -> depth panel opens
- All existing WorldMap functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/04-depth-layers-content-integration/04-03-SUMMARY.md`
</output>
