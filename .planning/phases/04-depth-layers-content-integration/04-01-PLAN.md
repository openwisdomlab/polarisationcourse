---
phase: 04-depth-layers-content-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/odyssey-world/concepts/conceptRegistry.ts
  - src/components/odyssey-world/concepts/crystalLabConcepts.ts
  - src/components/odyssey-world/concepts/refractionBenchConcepts.ts
  - src/stores/odysseyWorldStore.ts
  - src/i18n/locales/en.json
  - src/i18n/locales/zh.json
autonomous: true
requirements: [DISC-03, CONT-03]

must_haves:
  truths:
    - "Each discovered concept has three content layers: intuition, qualitative, and quantitative"
    - "Theory formulas are the deepest layer, positioned as culmination of understanding -- never prerequisites"
    - "Content is available in both Chinese and English"
    - "Store tracks which concept is active for depth panel and tooltip display"
  artifacts:
    - path: "src/components/odyssey-world/concepts/conceptRegistry.ts"
      provides: "ConceptDefinition type system and lookup utilities"
      exports: ["ConceptDefinition", "ConceptLayer", "RegionConcepts", "getConceptsForRegion", "getConceptForDiscovery", "getConceptById"]
    - path: "src/components/odyssey-world/concepts/crystalLabConcepts.ts"
      provides: "Crystal Lab concept definitions (3-5 concepts with full three-layer content)"
      exports: ["crystalLabConcepts"]
    - path: "src/components/odyssey-world/concepts/refractionBenchConcepts.ts"
      provides: "Refraction Bench concept definitions (2-3 concepts with full three-layer content)"
      exports: ["refractionBenchConcepts"]
    - path: "src/stores/odysseyWorldStore.ts"
      provides: "Depth panel state fields and actions"
      contains: "depthPanelConceptId"
    - path: "src/i18n/locales/en.json"
      provides: "English concept content translations"
      contains: "odyssey.concepts"
    - path: "src/i18n/locales/zh.json"
      provides: "Chinese concept content translations"
      contains: "odyssey.concepts"
  key_links:
    - from: "src/components/odyssey-world/concepts/crystalLabConcepts.ts"
      to: "src/components/odyssey-world/regions/crystalLab.ts"
      via: "discoveryId mapping to existing discovery config IDs"
      pattern: "discoveryId.*crystal-lab"
    - from: "src/components/odyssey-world/concepts/conceptRegistry.ts"
      to: "src/stores/odysseyWorldStore.ts"
      via: "concept IDs used by depth panel state"
      pattern: "depthPanelConceptId"
---

<objective>
Build the concept data model and store foundation for the three-layer depth system.

Purpose: Establishes the typed ConceptDefinition registry that maps existing discoveries to three-layer content (intuition/qualitative/quantitative), extends the store with depth panel state, and populates bilingual i18n content for Crystal Lab and Refraction Bench regions. This is the data foundation that all subsequent depth panel UI, demo embedding, and constellation map plans depend on.

Output: ConceptDefinition types, 2 region concept files with full content, store extensions, bilingual i18n keys
</objective>

<execution_context>
@/Users/jili/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jili/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-depth-layers-content-integration/04-CONTEXT.md
@.planning/phases/04-depth-layers-content-integration/04-RESEARCH.md
@src/stores/odysseyWorldStore.ts
@src/components/odyssey-world/regions/regionRegistry.ts
@src/components/odyssey-world/regions/crystalLab.ts
@src/components/odyssey-world/regions/refractionBench.ts
@src/i18n/locales/en.json
@src/i18n/locales/zh.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConceptDefinition type system and registry utilities</name>
  <files>src/components/odyssey-world/concepts/conceptRegistry.ts</files>
  <action>
Create the concept registry module with:

1. **ConceptLayer interface**: titleKey (string), contentKey (string) -- i18n keys for layer title and main explanation text.

2. **ConceptDefinition interface** (the core type):
   - id: string (unique concept ID, e.g. 'malus-law')
   - discoveryId: string (maps to existing discovery system IDs from regionRegistry discovery configs)
   - regionId: string (which region this concept belongs to)
   - nameKey: string (i18n key for concept name)
   - intuition: ConceptLayer (brief observational description of what the student already saw)
   - qualitative: ConceptLayer with diagramComponent string (React component ID for SVG diagram) and optional animationHints string array
   - quantitative: ConceptLayer with formulas array of { latex: string, labelKey: string } and optional derivationStepsKey string
   - demoComponentId: optional string (lazy-loaded explorer component ID for CONT-02)
   - triggerElementTypes: SceneElementType array (which element types show the hover tooltip)
   - triggerCondition: 'discovered' (only show tooltip after discovery -- invisible gating per research recommendation)
   - connections: array of { targetConceptId: string, type: 'causal' | 'analogous' | 'contrasting', labelKey: string }

3. **RegionConcepts interface**: regionId: string, concepts: ConceptDefinition[]

4. **CONCEPT_REGISTRY**: Map<string, RegionConcepts> -- populated by per-region concept files

5. **Utility functions**:
   - getConceptsForRegion(regionId: string): ConceptDefinition[] -- returns concepts for a region
   - getConceptForDiscovery(discoveryId: string): ConceptDefinition | undefined -- finds concept by discovery ID
   - getConceptById(conceptId: string): ConceptDefinition | undefined -- finds concept by its own ID
   - getConceptForElement(elementId: string, elementType: SceneElementType, regionId: string): ConceptDefinition | undefined -- finds concept triggered by an element type in a region
   - registerRegionConcepts(regionId: string, concepts: ConceptDefinition[]): void -- called by per-region files to register their concepts

Import SceneElementType from the store or regionRegistry as appropriate. The registry should be populated eagerly (not lazy) since concept data is lightweight strings/i18n keys.
  </action>
  <verify>pnpm run build -- no TypeScript errors in conceptRegistry.ts</verify>
  <done>ConceptDefinition type system exported, CONCEPT_REGISTRY populated via registerRegionConcepts, all 5 utility functions implemented and typed</done>
</task>

<task type="auto">
  <name>Task 2: Populate Crystal Lab and Refraction Bench concepts with store extensions and i18n</name>
  <files>
    src/components/odyssey-world/concepts/crystalLabConcepts.ts
    src/components/odyssey-world/concepts/refractionBenchConcepts.ts
    src/stores/odysseyWorldStore.ts
    src/i18n/locales/en.json
    src/i18n/locales/zh.json
  </files>
  <action>
**Crystal Lab concepts** (crystalLabConcepts.ts):
Create 3-5 ConceptDefinition objects for Crystal Lab's existing discoveries, then call registerRegionConcepts('crystal-lab', [...]).

Map to existing Crystal Lab discovery IDs from crystalLab.ts. For each concept, provide:
- Intuition layer: 1-2 sentence observational description (i18n key) -- what the student already saw when they achieved the discovery
- Qualitative layer: diagramComponent ID (e.g. 'malus-law-diagram'), explanation (i18n key), 2-3 paragraph explanation of why the phenomenon happens
- Quantitative layer: 1-3 LaTeX formulas (e.g. 'I = I_0 \\cos^2\\theta' for Malus's Law), formula label (i18n key)
- Connections to concepts in other regions (causal/analogous/contrasting)
- demoComponentId for concepts that will have demos (e.g. 'malus-law-explorer', 'circular-pol-explorer')
- triggerElementTypes: the SceneElementType that shows the tooltip (e.g. 'polarizer' for Malus's Law)

Key concepts to include: Malus's Law (mandatory -- the first discovery most students make), Crossed Polarizers, Circular Polarization (via QWP), Three-Polarizer Surprise.

**Refraction Bench concepts** (refractionBenchConcepts.ts):
Create 2-3 ConceptDefinition objects for Refraction Bench discoveries. Include Brewster's Angle (mandatory -- has a clear formula), Snell's Law for polarized light. demoComponentId: 'brewster-explorer'.

**Store extensions** (odysseyWorldStore.ts):
Add to the store state interface and initial state:
- depthPanelConceptId: string | null (null = panel closed)
- depthPanelActiveTab: 'qualitative' | 'quantitative' | 'demo' (default: 'qualitative')
- tooltipConceptId: string | null (null = no tooltip showing)
- tooltipPosition: { x: number; y: number } | null

Add actions:
- openDepthPanel(conceptId: string): sets depthPanelConceptId, resets tab to 'qualitative'
- closeDepthPanel(): sets depthPanelConceptId to null
- setDepthPanelTab(tab): updates depthPanelActiveTab
- showConceptTooltip(conceptId: string, x: number, y: number): sets tooltip state
- hideConceptTooltip(): clears tooltip state

These new fields do NOT need to be persisted (they are ephemeral UI state). Ensure they are excluded from the persist middleware partialize if needed.

**i18n content** (en.json and zh.json):
Add nested keys under "odyssey.concepts" for each concept across both regions. Structure:
```
"odyssey": {
  "concepts": {
    "malusLaw": {
      "name": "Malus's Law",
      "intuition": { "title": "What You Observed", "content": "When you rotated the polarizer..." },
      "qualitative": { "title": "Why This Happens", "content": "Light is a transverse wave..." },
      "quantitative": { "title": "The Mathematics", "derivation": "Starting from..." },
      "formulas": { "main": "Transmitted Intensity" }
    },
    ...
  }
}
```

Chinese translations should be physics-accurate with standard Chinese optics terminology (偏振, 马吕斯定律, 布儒斯特角, etc.). The qualitative content should be 2-3 paragraphs explaining the physics in accessible language. The quantitative formulas use standard LaTeX notation.

IMPORTANT: Theory formulas (quantitative layer) are always the deepest tab, never shown first. The default tab is 'qualitative' per CONT-03 requirement. The intuition description appears as a header/intro in the panel, not as a separate tab.
  </action>
  <verify>pnpm run build -- no TypeScript errors. Verify concept registry has entries: import and call getConceptsForRegion('crystal-lab') in a temporary test or console check.</verify>
  <done>Crystal Lab has 3-5 concepts and Refraction Bench has 2-3 concepts registered in CONCEPT_REGISTRY. Store has depth panel state fields and 5 actions. en.json and zh.json contain all concept content keys with real physics content in both languages.</done>
</task>

</tasks>

<verification>
1. `pnpm run build` succeeds with zero errors
2. ConceptDefinition type system is complete and exports all interfaces
3. getConceptsForRegion('crystal-lab') returns 3-5 concepts
4. getConceptsForRegion('refraction-bench') returns 2-3 concepts
5. getConceptForDiscovery returns a concept for each Crystal Lab discovery ID
6. Store has depthPanelConceptId, depthPanelActiveTab, tooltipConceptId, tooltipPosition fields
7. en.json and zh.json have matching key structure under odyssey.concepts
8. LaTeX formulas are valid KaTeX syntax (e.g. I = I_0 \cos^2\theta)
9. Each concept has connections array linking to concepts in other regions
</verification>

<success_criteria>
- Concept registry with 5-8 total concepts across Crystal Lab and Refraction Bench
- Three-layer content for every concept (intuition + qualitative + quantitative with formulas)
- Bilingual content (ZH/EN) for all layers
- Store depth panel state ready for UI consumption
- Formula-last ordering enforced by default tab being 'qualitative'
</success_criteria>

<output>
After completion, create `.planning/phases/04-depth-layers-content-integration/04-01-SUMMARY.md`
</output>
