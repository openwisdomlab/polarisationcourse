---
phase: 02-interaction-visual-language
plan: 03
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/components/odyssey-world/EnvironmentPopup.tsx
  - src/components/odyssey-world/hooks/useEnvironmentProperties.ts
  - src/stores/odysseyWorldStore.ts
autonomous: true
requirements: [INTR-03, INTR-05]

must_haves:
  truths:
    - "Student can click an environment object (light source, decoration) to open a contextual popup attached to it"
    - "Popup shows adjustable properties: medium type dropdown, refractive index slider, light source wavelength slider"
    - "Continuous property changes (sliders) animate smoothly and update beam physics in real-time"
    - "Discrete property changes (dropdowns) switch instantly with visual feedback"
    - "Popup disappears when clicking away from it"
    - "Popup has tooltip-style arrow pointer connecting it to the selected environment object"
  artifacts:
    - path: "src/components/odyssey-world/EnvironmentPopup.tsx"
      provides: "Contextual tooltip popup with sliders and dropdowns for environment properties"
      min_lines: 80
    - path: "src/components/odyssey-world/hooks/useEnvironmentProperties.ts"
      provides: "Hook managing popup state and property change dispatch"
      contains: "useEnvironmentProperties"
  key_links:
    - from: "src/components/odyssey-world/EnvironmentPopup.tsx"
      to: "src/stores/odysseyWorldStore.ts"
      via: "updateElement action for property changes"
      pattern: "updateElement"
    - from: "src/components/odyssey-world/hooks/useEnvironmentProperties.ts"
      to: "src/components/odyssey-world/hooks/useBeamPhysics.ts"
      via: "Property changes trigger beam recalculation through store update"
      pattern: "updateElement"
---

<objective>
Build environment manipulation: contextual popup for adjusting environment/material properties (medium type, refractive index, wavelength) with smooth animation for continuous values and instant switching for discrete values.

Purpose: Students can change environment properties to observe different polarization behaviors -- discovering how medium properties affect light without text explanation.
Output: EnvironmentPopup component with sliders/dropdowns, useEnvironmentProperties hook, extended store support for environment objects.
</objective>

<execution_context>
@/Users/jili/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jili/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-interaction-visual-language/02-RESEARCH.md
@.planning/phases/02-interaction-visual-language/02-01-SUMMARY.md

# Files this plan extends
@src/stores/odysseyWorldStore.ts
@src/components/odyssey-world/IsometricScene.tsx
@src/components/odyssey-world/LightSource.tsx

# Physics engine for property references
@src/core/physics/unified/FresnelSolver.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EnvironmentPopup component and useEnvironmentProperties hook</name>
  <files>
    src/components/odyssey-world/EnvironmentPopup.tsx
    src/components/odyssey-world/hooks/useEnvironmentProperties.ts
    src/stores/odysseyWorldStore.ts
  </files>
  <action>
**Store extension (`odysseyWorldStore.ts`):**

Add state field:
- `environmentPopupTarget: string | null` -- ID of the environment element whose popup is open

Add actions:
- `openEnvironmentPopup: (elementId: string) => void` -- sets `environmentPopupTarget`
- `closeEnvironmentPopup: () => void` -- sets `environmentPopupTarget` to null

Add new SceneElementType values if needed: the existing `'light-source'` type can hold environment properties. Add `'environment'` type to SceneElementType union for dedicated environment objects (e.g., a medium region). Add an environment scene element to `createInitialSceneElements()`:
```typescript
{
  id: 'environment-medium-1',
  type: 'environment' as SceneElementType,
  worldX: 4, worldY: 4, worldZ: 0,
  rotation: 0,
  properties: {
    mediumType: 'glass',
    refractiveIndex: 1.52,
    variant: 'medium-region',
  },
}
```

Also update the light source element to include `wavelength` in its properties (already has `wavelength: 550`).

**useEnvironmentProperties.ts:**

- Parameters: `elementId: string`
- Returns: `{ properties: Record<string, ...>, updateProperty: (key: string, value: number | string) => void, elementScreenPos: { x: number; y: number } }`
- Reads the element from store: `useOdysseyWorldStore((s) => s.sceneElements.find(el => el.id === elementId))`
- `updateProperty(key, value)`: calls `updateElement(elementId, { properties: { ...element.properties, [key]: value } })`. For continuous values, this triggers beam recalculation on every slider change (beam physics is fast <1ms per research)
- `elementScreenPos`: calculates screen position of the element using `worldToScreen` + camera transform for popup positioning

**EnvironmentPopup.tsx:**

A React component rendered as an HTML overlay (NOT SVG -- HTML gives better form controls for sliders and dropdowns). Positioned absolutely over the scene using CSS `position: absolute` + `transform: translate()` based on element screen position.

Visual design:
- Tooltip style with arrow pointer (CSS triangle pointing toward the element)
- Semi-transparent backdrop: `background: rgba(20, 20, 30, 0.85)`, `backdrop-filter: blur(8px)`, `border-radius: 8px`
- Compact width (~200px)
- Framer Motion `AnimatePresence` for enter/exit animation (scale from 0.9 + fade)

Properties to show (varies by element type):

For `light-source`:
- **Wavelength** slider: 380-780nm range, step 1nm. Shows color preview (wavelength to visible color). Updates `properties.wavelength`
- **Intensity** slider: 0-1 range, step 0.01. Updates `properties.intensity`
- **Polarization** dropdown: horizontal, vertical, 45-degree, circular-right, circular-left, unpolarized. Updates `properties.polarization`

For `environment`:
- **Medium Type** dropdown: vacuum, air, water, glass, diamond, calcite, quartz (from `FresnelSolver.REFRACTIVE_INDICES`). On change, auto-update refractive index to the standard value. Instant switch.
- **Refractive Index** slider: 1.0-2.5 range, step 0.01. Shows current value. Smooth animation per user decision. Updates `properties.refractiveIndex`

Slider implementation:
- Use native `<input type="range">` styled with Tailwind
- On `input` event: call `updateProperty` for real-time beam update
- Show current value as small label next to slider
- Continuous values animate smoothly (the beam recalculates on each slider step, Framer Motion spring on the slider thumb is optional but nice)

Dropdown implementation:
- Use native `<select>` or custom dropdown styled with Tailwind
- On change: instant property update, beam recalculates immediately

Dismissal:
- Click outside the popup: close via `closeEnvironmentPopup()`
- Use a `useEffect` with `document.addEventListener('pointerdown', handler)` to detect outside clicks
- The popup handler must `e.stopPropagation()` on its own pointerdown to prevent self-dismissal

Popup positioning:
- Calculate from element's world position -> screen position using camera state
- Offset popup above the element (negative Y offset)
- Arrow points down toward the element
- Clamp to viewport bounds (don't let popup overflow off-screen)
- Update position when camera moves (subscribe to camera MotionValues)

For LightSource and environment objects, make them clickable:
- In LightSource.tsx (or via the IsometricScene element renderer), add `onClick` handler that calls `openEnvironmentPopup(element.id)` when clicking a light source or environment element
- The click handler should NOT interfere with click-to-move (use `e.stopPropagation()`)
- Show a subtle interaction cue on hover (reuse the `element-hover-glow` filter from 02-02, or apply it independently since this plan runs in parallel)

NOTE: This plan touches `odysseyWorldStore.ts` (also modified by 02-01). Since 02-01 is in Wave 1 and this is Wave 2, the store changes from 02-01 will be present. This plan adds `environmentPopupTarget`, `openEnvironmentPopup`, `closeEnvironmentPopup`, and a new `'environment'` SceneElementType. These additions are additive and do not conflict with 02-01's CRUD actions.
  </action>
  <verify>
`pnpm run build` passes. EnvironmentPopup renders as HTML overlay with correct positioning. Sliders produce smooth property updates. Dropdown switches medium type instantly. Clicking outside dismisses popup. Light source and environment elements are clickable and open the popup.
  </verify>
  <done>
EnvironmentPopup renders as a tooltip-style HTML overlay with arrow pointer. Light source popup shows wavelength slider (380-780nm with color preview), intensity slider (0-1), and polarization dropdown. Environment popup shows medium type dropdown (with auto refractive index update) and refractive index slider (1.0-2.5). Continuous values animate smoothly. Discrete values switch instantly. Popup dismisses on outside click. Click on light source or environment element opens popup without triggering navigation. Beam physics updates in real-time on property changes.
  </done>
</task>

</tasks>

<verification>
1. `pnpm run build` -- zero TypeScript errors
2. Clicking light source opens popup with wavelength, intensity, polarization controls
3. Clicking environment element opens popup with medium type and refractive index controls
4. Slider movement causes immediate beam recalculation (visible beam change)
5. Dropdown change causes instant beam recalculation
6. Clicking outside popup dismisses it
7. Popup arrow pointer points toward the target element
</verification>

<success_criteria>
- Students can change environment properties through in-world contextual popups
- Property changes cause visible, real-time beam behavior changes
- Popups feel attached to the world (tooltip style) not like external UI
- Build passes, no new dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/02-interaction-visual-language/02-03-SUMMARY.md`
</output>
