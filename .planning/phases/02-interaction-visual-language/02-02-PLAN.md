---
phase: 02-interaction-visual-language
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/components/odyssey-world/OpticalElement.tsx
  - src/components/odyssey-world/ElementPalette.tsx
  - src/components/odyssey-world/BeamGlowFilters.tsx
  - src/components/odyssey-world/IsometricScene.tsx
  - src/components/odyssey-world/LightBeam.tsx
  - src/components/odyssey-world/OdysseyWorld.tsx
autonomous: true
requirements: [INTR-01, INTR-02, INTR-04, INTR-05, VISL-03, PHYS-03]

must_haves:
  truths:
    - "Student can drag an optical element from a diegetic palette onto the beam path and it snaps into position"
    - "Student can drag a placed element along the beam path to reposition it, with ghost beam preview during drag"
    - "Student can rotate a placed element via drag handle (arc with dot) or scroll wheel, with angle readout visible"
    - "Dragging an element away from the beam path removes it and returns it to the palette"
    - "Interactive elements show soft luminous glow on hover and bright outline + name label on selection"
    - "Custom cursors (grab for draggable, rotate for rotatable) appear on interactive elements"
    - "Scroll wheel on selected element rotates it instead of zooming the camera"
    - "Ghost beam preview shows tentative beam path at 30% opacity during drag"
    - "Beam remains the brightest visual element in the scene via self-luminous glow"
  artifacts:
    - path: "src/components/odyssey-world/OpticalElement.tsx"
      provides: "Interactive optical element with hover/selected/dragging states, rotation handle, angle readout"
      min_lines: 80
    - path: "src/components/odyssey-world/ElementPalette.tsx"
      provides: "Diegetic equipment shelf SVG with draggable element previews"
      min_lines: 60
    - path: "src/components/odyssey-world/LightBeam.tsx"
      provides: "Ghost beam preview rendering at low opacity"
      contains: "ghost"
    - path: "src/components/odyssey-world/BeamGlowFilters.tsx"
      provides: "Additional SVG filter definitions for hover glow and selection glow"
      contains: "element-hover-glow"
  key_links:
    - from: "src/components/odyssey-world/OpticalElement.tsx"
      to: "src/components/odyssey-world/hooks/useElementDrag.ts"
      via: "Wires pointer event handlers from drag hook to SVG element"
      pattern: "useElementDrag"
    - from: "src/components/odyssey-world/OpticalElement.tsx"
      to: "src/components/odyssey-world/hooks/useElementRotation.ts"
      via: "Wires rotation handlers to arc handle and wheel event"
      pattern: "useElementRotation"
    - from: "src/components/odyssey-world/ElementPalette.tsx"
      to: "src/stores/odysseyWorldStore.ts"
      via: "addElement action when palette element is dragged to beam"
      pattern: "addElement"
    - from: "src/components/odyssey-world/IsometricScene.tsx"
      to: "src/components/odyssey-world/LightBeam.tsx"
      via: "Renders ghost beam preview layer above main beam layer"
      pattern: "layer-beam-preview"
---

<objective>
Build the interactive optical element UI: upgrade OpticalElement with hover/selection/drag/rotation states, create the diegetic equipment palette, add ghost beam preview rendering, and implement visual interaction cues (glow, cursors, angle readout, snap hints).

Purpose: This is the core interaction experience -- students see and feel the interactivity of optical elements through visual affordances and direct manipulation.
Output: Fully interactive optical elements with drag-and-drop, rotation, palette, ghost preview, and visual cues.
</objective>

<execution_context>
@/Users/jili/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jili/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-interaction-visual-language/02-RESEARCH.md
@.planning/phases/02-interaction-visual-language/02-01-SUMMARY.md

# Files this plan modifies/extends
@src/components/odyssey-world/OpticalElement.tsx
@src/components/odyssey-world/BeamGlowFilters.tsx
@src/components/odyssey-world/IsometricScene.tsx
@src/components/odyssey-world/LightBeam.tsx
@src/components/odyssey-world/OdysseyWorld.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade OpticalElement with interactive states, rotation handle, palette, and visual cues</name>
  <files>
    src/components/odyssey-world/OpticalElement.tsx
    src/components/odyssey-world/ElementPalette.tsx
    src/components/odyssey-world/BeamGlowFilters.tsx
  </files>
  <action>
**OpticalElement.tsx -- complete rewrite for interactivity:**

Wire the three hooks from Plan 01: `useElementDrag`, `useElementRotation`, `useElementSelection`. The component needs access to `containerRef`, `cameraX`, `cameraY`, `zoom` -- pass these as props (they originate from OdysseyWorld/IsometricScene).

Interactive states (driven by store selectors `selectedElementId`, `hoveredElementId`):
- **Default**: Current Phase 1 appearance (polarizer parallel lines, waveplate diagonal hatching). No filter.
- **Hovered**: Apply `filter="url(#element-hover-glow)"` to the element group. Set `cursor: grab` via inline style.
- **Selected**: Apply `filter="url(#element-select-glow)"` to element group. Show bright outline (stroke-width: 2, stroke: #6CB4FF at 80% opacity). Show element name/type label as `<text>` positioned above the element (e.g., "Polarizer", "Quarter-Wave Plate"). Show rotation handle (see below). Set `cursor: grab`.
- **Dragging**: Element follows pointer position (use `useRef` position, not store). Apply opacity 0.6 to indicate in-motion. Set `cursor: grabbing`. Show snap hint: beam segment nearest to element brightens/pulses (add a `className` or data attribute for the nearest segment ID, consumed by IsometricScene).
- **Rotating**: Show angle readout as `<text>` near the rotation arc endpoint. Format: "{angle}deg" in small monospace font, 70% opacity. Set `cursor` to custom rotate SVG cursor (data URI from research).

Rotation handle design (Claude's discretion -- arc handle):
- Render as a 90-degree SVG `<path>` arc centered on the element, radius ~30px in screen space
- A small circle (r=4) at the arc endpoint serves as the drag target
- Tick marks at 0/45/90 degree positions on the arc (short `<line>` elements)
- The arc appears when the element is selected
- After the student has rotated any element once (track via a `hasRotated` flag in store or local state), fade the arc to 15% opacity (hint mode). The arc returns to full opacity on hover.

Angle readout during rotation:
- Position near the arc endpoint
- Show current angle in degrees: "45.0deg"
- Use `<text>` with `font-family: monospace`, `font-size: 10`, `fill: rgba(255,255,255,0.7)`
- Only visible while `isRotating` is true OR element is selected

Pointer event wiring:
- `onPointerDown` -> `useElementSelection.onPointerDown` + `useElementDrag.onPointerDown`
- `onPointerMove` -> route to `useElementDrag.onPointerMove` or `useElementRotation.onRotatePointerMove` based on which started
- `onPointerUp` -> `useElementDrag.onPointerUp` / `useElementRotation.onRotatePointerUp` / `useElementSelection.onPointerUp`
- `onPointerEnter` -> `useElementSelection.onPointerEnter`
- `onPointerLeave` -> `useElementSelection.onPointerLeave`
- `onWheel` -> `useElementRotation.onWheel` (when selected, stopPropagation to prevent camera zoom)
- All pointer handlers call `e.stopPropagation()` to prevent click-to-move navigation

Element types to support (4 elements per research recommendation):
- **Linear Polarizer**: Existing parallel lines visual. Properties: `transmissionAxis` (degrees)
- **Quarter-Wave Plate**: Existing diagonal hatching. Properties: `fastAxis` (degrees), `retardation: 90`
- **Half-Wave Plate**: Similar to QWP but with double-hatching or thicker lines. Properties: `fastAxis` (degrees), `retardation: 180`
- **Analyzer**: Identical visual to polarizer but labeled differently. Properties: `transmissionAxis` (degrees)

**ElementPalette.tsx -- new component (diegetic equipment shelf):**

Design: A small SVG group positioned at the lower-left of the scene (world coordinates roughly (-1, 6) or similar edge position). Styled as part of the laboratory -- a wooden shelf or equipment rack in isometric perspective.

Contents: 4 draggable element previews (one for each type above). Each shows:
- A small (20x20px equivalent) preview of the element's visual
- No text label (diegetic, not UI)
- Soft idle animation (subtle breathing scale, like existing decorations)

Drag from palette:
- On `pointerdown` on a palette item, create a new `SceneElement` with a generated ID (e.g., `crypto.randomUUID()` or `Date.now().toString(36)`) and default properties
- Enter drag mode immediately (no click threshold for palette items)
- The new element follows the pointer, same as repositioning drag
- On drop on beam path: call `addElement(newElement)` with snapped position
- On drop off beam path: cancel (element disappears, no store change)

When an element is removed from the beam (dragged off), it returns to the palette. Track available palette counts in component state or store.

**BeamGlowFilters.tsx -- extend with interaction filters:**

Add to existing SVG `<defs>`:
- `element-hover-glow`: `feGaussianBlur` stdDeviation 0.8, flood color `#6CB4FF` at 40% opacity, merged with source graphic
- `element-select-glow`: `feGaussianBlur` stdDeviation 1.2, flood color `#4DA6FF` at 60% opacity, merged with source graphic
- `snap-hint-pulse`: animated filter or CSS animation class for beam segment pulsing near snap point

Ensure beam glow filters remain at higher stdDeviation (1.5) than element filters (0.8-1.2) to maintain beam visual dominance (VISL-03).
  </action>
  <verify>
`pnpm run build` passes. OpticalElement renders with correct interactive states (hover glow, selection outline, rotation handle). ElementPalette renders 4 element previews. BeamGlowFilters defines `element-hover-glow` and `element-select-glow` filter IDs. Custom rotate cursor appears in the cursor style declaration.
  </verify>
  <done>
OpticalElement has full interactive lifecycle (hover -> select -> drag/rotate). Rotation handle appears as 90-degree arc with dot and tick marks. Angle readout shows during rotation. ElementPalette provides 4 draggable optical elements in a diegetic shelf design. Custom cursors (grab, grabbing, rotate) applied per state. SVG filters for hover and selection glow added. All interaction cues are visual-only (no text instructions).
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire interactions into scene -- ghost beam preview, scene-level event routing, beam dominance</name>
  <files>
    src/components/odyssey-world/IsometricScene.tsx
    src/components/odyssey-world/LightBeam.tsx
    src/components/odyssey-world/OdysseyWorld.tsx
  </files>
  <action>
**IsometricScene.tsx -- add interaction layers and event routing:**

Add new SVG layer groups in the rendering order:
1. Layer 0: Background (existing)
2. Layer 1: Platforms (existing)
3. Layer 2: Objects -- OpticalElement now receives interaction props (`containerRef`, `cameraX`, `cameraY`, `zoom`)
4. Layer 3: Beam (existing LightBeam segments)
5. **Layer 3.5: Ghost Beam Preview** -- new `<g className="layer-beam-preview" opacity={0.3} style={{ pointerEvents: 'none' }}>`. Render `useBeamPreview()` segments here using the same `LightBeam` component but with a `ghost` prop
6. Layer 4: Avatar (existing)
7. **Layer 5: ElementPalette** -- render palette as a fixed-position overlay within the SVG, positioned at scene edge

Pass `containerRef`, camera MotionValues, and zoom to OpticalElement components. The container ref should be the `motion.div` that wraps the SVG (where the camera transform is applied).

Scene-level click handler (existing click-to-move): Add a check -- if `interactionMode` is not `'navigate'`, do NOT trigger navigation. This preserves the existing click-to-move for empty-area clicks while preventing it during element manipulation.

Deselection: When clicking empty SVG area (not on any element), call `selectElement(null)` to deselect.

**LightBeam.tsx -- ghost preview mode:**

Accept an optional `ghost?: boolean` prop.
- When `ghost` is true: render the beam with 30% opacity, no particles (skip `BeamParticles`), thinner stroke (strokeWidth * 0.7), and a dashed stroke-dasharray to visually distinguish from the real beam
- The ghost beam uses the same color encoding as the real beam (consistent polarization visual language -- PHYS-03)
- Ghost beam should NOT have glow filter applied (keep visual hierarchy clear, beam glow only on real beam -- VISL-03)

**OdysseyWorld.tsx -- hook wiring:**

Add the `useBeamPreview` hook call and pass `previewSegments` to `IsometricScene`.
Ensure the `containerRef` from `useIsometricCamera` is accessible and can be passed down to OpticalElement components.

Beam visual dominance enforcement (VISL-03):
- Real beam: stdDeviation 1.5 glow (existing), always brightest
- Ghost beam: no glow, 30% opacity, dashed
- Element hover glow: stdDeviation 0.8, softer color
- Element selection glow: stdDeviation 1.2, slightly brighter than hover but still less than beam
- This ensures the beam is always the most visually prominent element
  </action>
  <verify>
`pnpm run build` passes. IsometricScene renders the ghost beam preview layer. LightBeam accepts `ghost` prop and renders differently. Click-to-move still works when clicking empty areas. Clicking an element does NOT trigger navigation. Deselection works on empty-area click.
  </verify>
  <done>
Scene fully wired with interactive optical elements, ghost beam preview layer, element palette, and proper event routing. Click-to-move preserved for empty areas, prevented during element interaction. Ghost beam renders at 30% opacity with dashed stroke and no glow. Beam remains visually dominant via filter hierarchy. ElementPalette positioned at scene edge within SVG.
  </done>
</task>

</tasks>

<verification>
1. `pnpm run build` -- zero TypeScript errors
2. OpticalElement shows hover glow, selection glow + outline + name label, rotation handle arc
3. ElementPalette renders 4 element types
4. Ghost beam preview appears during drag at 30% opacity
5. Click-to-move works on empty areas, does NOT fire when clicking elements
6. Scroll wheel on selected element rotates it (no camera zoom)
7. Beam glow (stdDeviation 1.5) > selection glow (1.2) > hover glow (0.8) -- visual hierarchy maintained
</verification>

<success_criteria>
- Students can see interactive affordances without text instructions
- Drag, drop, rotate, and remove all function through visual manipulation
- Ghost beam preview provides "what if" feedback during drag
- Beam remains the visually dominant scene element
- Build passes, all interaction cues are visual-only
</success_criteria>

<output>
After completion, create `.planning/phases/02-interaction-visual-language/02-02-SUMMARY.md`
</output>
