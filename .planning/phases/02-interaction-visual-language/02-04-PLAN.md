---
phase: 02-interaction-visual-language
plan: 04
type: execute
wave: 3
depends_on: [02-02, 02-03]
files_modified:
  - src/components/odyssey-world/hooks/useDiscoveryState.ts
  - src/components/odyssey-world/DiscoveryFeedback.tsx
  - src/components/odyssey-world/PolarizationLegend.tsx
  - src/stores/odysseyWorldStore.ts
  - src/components/odyssey-world/IsometricScene.tsx
  - src/components/odyssey-world/OdysseyWorld.tsx
autonomous: false
requirements: [DISC-01, DISC-04, PHYS-03]

must_haves:
  truths:
    - "Rotating polarizer through 90+ degrees range triggers the Malus's Law discovery (intensity gradient illumination response)"
    - "Crossing two polarizers at 90 degrees triggers the Complete Extinction discovery (hidden phosphorescent pattern revealed)"
    - "Placing QWP at 45 degrees to linear polarization triggers Circular Polarization discovery (crystal sparkle response)"
    - "HWP rotates polarization direction triggering the Half-Wave Rotation discovery (surface shimmer response)"
    - "Inserting polarizer between crossed pair triggers Three-Polarizer Surprise (brightest environmental response)"
    - "Discoveries are visually persistent -- once triggered, environmental changes remain visible in the scene"
    - "Polarization legend reveals items progressively as student discovers each encoding aspect (color, intensity, shape)"
    - "Environmental responses are subtle and organic, not flashy (The Witness panels lighting up quality)"
  artifacts:
    - path: "src/components/odyssey-world/hooks/useDiscoveryState.ts"
      provides: "Discovery configuration definitions, state tracking, check functions"
      contains: "useDiscoveryState"
    - path: "src/components/odyssey-world/DiscoveryFeedback.tsx"
      provides: "SVG environmental response animations (illumination, color shift, patterns, particles)"
      min_lines: 100
    - path: "src/components/odyssey-world/PolarizationLegend.tsx"
      provides: "Progressive legend revealing encoding aspects (orientation, intensity, ellipticity)"
      min_lines: 40
  key_links:
    - from: "src/components/odyssey-world/hooks/useDiscoveryState.ts"
      to: "src/stores/odysseyWorldStore.ts"
      via: "Reads sceneElements and beamSegments to check discovery conditions"
      pattern: "sceneElements.*beamSegments"
    - from: "src/components/odyssey-world/DiscoveryFeedback.tsx"
      to: "src/components/odyssey-world/hooks/useDiscoveryState.ts"
      via: "Renders environmental responses for achieved discoveries"
      pattern: "achievedDiscoveries"
    - from: "src/components/odyssey-world/PolarizationLegend.tsx"
      to: "src/stores/odysseyWorldStore.ts"
      via: "Reads discoveredEncodings to show/hide legend items"
      pattern: "discoveredEncodings"
---

<objective>
Build the discovery and feedback system: 5 physics discovery configurations that trigger environmental responses, and a progressive polarization legend that teaches the visual encoding system through interaction.

Purpose: This is the learning payoff -- students discover Malus's Law, circular polarization, and other phenomena through manipulation, with the environment itself confirming correct configurations. The progressive legend ensures students understand the visual encoding without upfront instruction.
Output: Discovery tracking system with 5 configurations, environmental response animations, progressive polarization legend.
</objective>

<execution_context>
@/Users/jili/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jili/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-interaction-visual-language/02-RESEARCH.md
@.planning/phases/02-interaction-visual-language/02-01-SUMMARY.md
@.planning/phases/02-interaction-visual-language/02-02-SUMMARY.md
@.planning/phases/02-interaction-visual-language/02-03-SUMMARY.md

# Physics engine for discovery condition calculations
@src/core/physics/unified/MuellerMatrix.ts
@src/core/physics/unified/PolarizationState.ts
@src/components/odyssey-world/hooks/useBeamPhysics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build discovery state system with 5 physics configurations and environmental responses</name>
  <files>
    src/components/odyssey-world/hooks/useDiscoveryState.ts
    src/components/odyssey-world/DiscoveryFeedback.tsx
    src/stores/odysseyWorldStore.ts
  </files>
  <action>
**Store extension (`odysseyWorldStore.ts`):**

Add state:
- `achievedDiscoveries: Set<string>` -- IDs of discoveries achieved this session (initialized empty). Use `Set` for O(1) lookup. NOTE: Zustand immutability -- wrap in new Set on each update.
- `discoveredEncodings: { orientation: boolean; intensity: boolean; ellipticity: boolean; intensityOpacity: boolean }` -- tracks which polarization encoding aspects the student has observed. All start `false`.
- `rotationHistory: Map<string, number[]>` -- tracks rotation angles per element for discovery detection (e.g., Malus's Law needs 90+ degree range)

Add actions:
- `achieveDiscovery: (discoveryId: string) => void` -- adds to `achievedDiscoveries` (only if not already present)
- `discoverEncoding: (aspect: 'orientation' | 'intensity' | 'ellipticity' | 'intensityOpacity') => void` -- sets the encoding flag to true
- `recordRotation: (elementId: string, angle: number) => void` -- appends angle to rotation history for that element

**useDiscoveryState.ts:**

Define 5 `DiscoveryConfig` objects (interface from research):

```typescript
interface DiscoveryConfig {
  id: string
  name: string
  check: (elements: SceneElement[], beamSegments: BeamSegment[], rotationHistory: Map<string, number[]>) => boolean
  response: {
    type: 'illuminate' | 'color-shift' | 'pattern' | 'particle-burst'
    target: string   // SVG group/area to animate
    params: Record<string, number | string>
  }
}
```

**Discovery 1 -- Malus's Law intensity** (`malus-law-basic`):
- Check: Find at least 2 polarizers in the scene. Check if any polarizer's rotation history spans >= 90 degrees (max - min >= 90). Also verify beam segments show at least 3 distinct intensity levels (check `stokes.s0` values across segments, requiring at least 3 values differing by > 0.1).
- Response: `type: 'illuminate'`, target: `'discovery-area-malus'` -- a measurement scale area near the beam. A gradient of light spreads along a surface, showing relative intensity levels. Color: warm gold `hsl(45, 80%, 60%)`.

**Discovery 2 -- Complete Extinction** (`crossed-polarizers`):
- Check: Find at least 2 polarizers whose `transmissionAxis` differ by 85-95 degrees (within tolerance of perfect 90). The beam segment between them must have `stokes.s0 < 0.05` (nearly zero intensity).
- Response: `type: 'pattern'`, target: `'discovery-area-extinction'` -- in the dark region where the beam goes extinct, a faint phosphorescent pattern is revealed (SVG pattern element that was previously invisible, now animates to ~20% opacity). This teaches that "absence of light can reveal something."

**Discovery 3 -- Circular Polarization** (`circular-polarization`):
- Check: Find a waveplate with `retardation: 90` (QWP) where the input beam is linearly polarized and the angle between the beam's polarization orientation and the waveplate's fast axis is between 40-50 degrees (near 45 for circular). The output beam segment must have `|stokes.s3| > 0.4` (significant circular component) and `shape === 'helix'`.
- Response: `type: 'particle-burst'`, target: `'discovery-area-circular'` -- crystal decorations near the QWP sparkle with circular particle animations (small circles that rotate, suggesting circular motion). Subtle, 2-3 second animation, then settles to a persistent gentle shimmer.

**Discovery 4 -- Half-Wave Rotation** (`half-wave-rotation`):
- Check: Find a waveplate with `retardation: 180` (HWP) in the scene. The output beam must have a different color (hue) than the input beam but similar intensity (`|stokes.s0_out - stokes.s0_in| < 0.1`). This shows polarization direction change without intensity loss.
- Response: `type: 'color-shift'`, target: `'discovery-area-hwp'` -- nearby decorative surfaces shift color, as if reflecting the new polarization color. Smooth 1-second transition.

**Discovery 5 -- Three-Polarizer Surprise** (`three-polarizer-surprise`):
- Check: Find exactly 3 polarizers in the scene. The first and last must be crossed (85-95 degree difference). The middle polarizer must be at an angle between them. The final beam segment (after all three) must have `stokes.s0 > 0.05` (light restored!). This is the most dramatic -- light passes through what should be an opaque barrier.
- Response: `type: 'illuminate'`, target: `'discovery-area-surprise'` -- the most dramatic environmental response. A wider area brightens significantly. Surrounding decorations react visibly. This is the "wow" moment.

Hook implementation:
- Subscribe to `sceneElements` and `beamSegments` via store selectors
- On each change, check all DiscoveryConfigs where `id` is NOT in `achievedDiscoveries`
- If a check returns true, call `achieveDiscovery(config.id)`
- Use `useEffect` with `[sceneElements, beamSegments]` dependencies
- Throttle checks to max once per 200ms (debounce via `setTimeout`) to avoid checking on every keystroke during rapid rotation
- Return `{ achievedDiscoveries, newlyAchieved: string | null }` -- `newlyAchieved` is set briefly (500ms) when a new discovery fires, for triggering entry animations

Also track encoding discoveries:
- When beam hue changes (orientation encoding): set `orientation: true`
- When beam opacity drops below 0.5 (intensity encoding): set `intensity: true`
- When beam shape becomes `'helix'` (ellipticity encoding): set `ellipticity: true`
- When beam opacity varies across segments (intensity->opacity mapping): set `intensityOpacity: true`
- Check these on every `beamSegments` change, with 1-second delay (per research recommendation)

**DiscoveryFeedback.tsx:**

SVG component rendered in IsometricScene as a dedicated layer (between objects and beam layers, so environmental effects appear behind the beam).

For each achieved discovery, render the corresponding environmental response as persistent SVG elements:

- `type: 'illuminate'`: Render a `<radialGradient>` + `<ellipse>` or `<rect>` at the target area, animated from 0% to target opacity via Framer Motion `animate`. Color from config params. Persistent after animation.
- `type: 'color-shift'`: Render a colored overlay on target SVG elements using `<use>` or a mask. Framer Motion `animate` color transition over 1 second.
- `type: 'pattern'`: Render an SVG `<pattern>` element (geometric lines, dots, or crystal-like shapes) that fades in from 0% to 20-30% opacity. The pattern should feel like hidden writing revealed by darkness.
- `type: 'particle-burst'`: Use Framer Motion `AnimatePresence` + `motion.circle` for 8-12 small particles that burst outward from the target, then settle into a gentle orbiting/shimmer animation. After burst (2-3s), reduce to 3-4 persistent shimmer particles.

All responses must be subtle and organic (The Witness quality):
- No sharp edges, no game-like particle explosions
- Use spring animations with low stiffness (40-60) and high damping (15-20)
- Colors should complement the scene palette (warm golds, soft blues, muted greens)
- Opacity should be modest (15-40%) so environmental changes don't compete with beam (VISL-03)

Discovery response areas need to be positioned in the scene. Add SVG `<g>` groups in IsometricScene with IDs matching the discovery targets:
- `discovery-area-malus`: near the beam path center
- `discovery-area-extinction`: in the shadow zone between crossed polarizers
- `discovery-area-circular`: near crystal decorations
- `discovery-area-hwp`: on decorative surfaces
- `discovery-area-surprise`: wider area, most dramatic spread
  </action>
  <verify>
`pnpm run build` passes. Discovery configs define 5 check functions with correct Stokes parameter thresholds. DiscoveryFeedback renders environmental responses as SVG elements. Achieved discoveries persist visually in the scene.
  </verify>
  <done>
5 discovery configurations defined with physics-based check functions. Environmental responses render as persistent SVG animations (illuminate, color-shift, pattern, particle-burst). Responses are subtle and organic. Discovery state tracked in store with Set for O(1) lookup. Encoding discovery tracking watches for beam hue changes, opacity drops, helix shape, and intensity variation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build progressive polarization legend and wire everything into the scene</name>
  <files>
    src/components/odyssey-world/PolarizationLegend.tsx
    src/components/odyssey-world/IsometricScene.tsx
    src/components/odyssey-world/OdysseyWorld.tsx
  </files>
  <action>
**PolarizationLegend.tsx:**

An HTML overlay (not SVG) positioned at the bottom-right of the scene viewport (near the minimap but not overlapping).

Design:
- Semi-transparent backdrop matching the HUD style: `background: rgba(20, 20, 30, 0.7)`, `backdrop-filter: blur(6px)`, `border-radius: 6px`, `padding: 8px 12px`
- Title: "Polarization" in small caps, 10px font, 50% opacity -- appears only after the first encoding is discovered
- Each legend item appears one by one as the student discovers the encoding aspect

Legend items (4 total, progressive reveal):
1. **Orientation** (revealed when `discoveredEncodings.orientation` becomes true):
   - Small colored beam preview showing hue range (red -> green -> blue arc or 3 colored line samples)
   - Label: "Color = Direction" (minimal text, not formula)
   - Framer Motion `AnimatePresence` fade-in from below

2. **Intensity** (revealed when `discoveredEncodings.intensity` becomes true):
   - Small beam samples at different opacities (100%, 50%, 10%)
   - Label: "Brightness = Intensity"

3. **Ellipticity** (revealed when `discoveredEncodings.ellipticity` becomes true):
   - Three beam shape samples: straight line, ellipse markers, helix
   - Label: "Shape = Polarization Type"

4. **Intensity-Opacity** (revealed when `discoveredEncodings.intensityOpacity` becomes true):
   - Beam width comparison (thick = strong, thin = weak)
   - Label: "Width = Strength"

Each item animates in with Framer Motion spring (stiffness 100, damping 15) and a subtle glow pulse on first appearance (like a gentle notification).

The legend grows vertically as items are added. Maximum height accommodates all 4 items (~120px).

**IsometricScene.tsx updates:**

Add DiscoveryFeedback as a new SVG layer:
- Insert between Layer 2 (objects) and Layer 3 (beam): `<g className="layer-discovery-feedback">`
- This ensures discovery environmental effects appear BEHIND the beam (beam visual dominance -- VISL-03)

Add discovery area placeholder groups:
```tsx
<g id="discovery-area-malus" transform={worldToScreen(3.5, 3, 0)} />
<g id="discovery-area-extinction" transform={worldToScreen(4, 3, 0)} />
<g id="discovery-area-circular" transform={worldToScreen(5.5, 3, 0)} />
<g id="discovery-area-hwp" transform={worldToScreen(4, 3, 0)} />
<g id="discovery-area-surprise" transform={worldToScreen(3, 3, 0)} />
```
Position these near the relevant optical elements in the initial scene layout.

**OdysseyWorld.tsx updates:**

Wire the `useDiscoveryState` hook. Pass discovery state to IsometricScene and PolarizationLegend.

Add PolarizationLegend as an HTML overlay (sibling to HUD, not inside SVG):
```tsx
<PolarizationLegend discoveredEncodings={discoveredEncodings} />
```

Integration with rotation tracking:
- In the OpticalElement component (or via the rotation hook), call `recordRotation(elementId, angle)` on each rotation commit. This feeds the Malus's Law discovery check.

**Final integration check:**
Ensure the complete interaction flow works end-to-end:
1. Student hovers element -> glow appears
2. Student clicks element -> selected state (outline, label, rotation handle)
3. Student rotates element -> beam changes color/intensity, angle readout shows
4. After sufficient exploration -> discovery triggers -> environmental response animates in
5. After beam color changes -> legend item reveals "Color = Direction"
6. Student drags from palette -> new element follows cursor -> ghost beam preview -> snap to beam path
7. Student changes environment property -> popup slider -> beam recalculates
  </action>
  <verify>
`pnpm run build` passes. PolarizationLegend renders progressively (start empty, items appear as encodings are discovered). DiscoveryFeedback layer renders between objects and beam layers. Discovery area groups are positioned correctly in the scene. End-to-end interaction flow compiles without errors.
  </verify>
  <done>
Progressive polarization legend reveals 4 items as student discovers each encoding aspect (orientation, intensity, ellipticity, intensity-opacity). Discovery feedback renders as an SVG layer behind the beam maintaining visual hierarchy. Discovery area groups positioned near relevant scene elements. OdysseyWorld wires discovery state hook and passes data to scene and legend components. Full end-to-end interaction flow wired from hover through discovery to legend reveal.
  </done>
</task>

</tasks>

<verification>
1. `pnpm run build` -- zero TypeScript errors
2. Each of the 5 discovery check functions has specific, physics-based thresholds (not vague)
3. Environmental responses are subtle (opacity 15-40%, spring animation, no flashy particles)
4. Legend starts empty, items appear one by one through interaction
5. Beam layer renders above discovery feedback layer (visual dominance maintained)
6. Discovery achievements persist within the session (re-checking doesn't re-trigger)
7. Encoding discovery triggers have 1-second delay before revealing legend item
</verification>

<success_criteria>
- Students discover 5 physics phenomena through manipulation, confirmed by environmental feedback
- Progressive legend teaches the visual encoding system through doing, not reading
- Environmental responses feel organic and subtle (The Witness quality)
- Beam remains visually dominant even with environmental feedback active
- All 9 phase requirements addressed across all 4 plans
</success_criteria>

<output>
After completion, create `.planning/phases/02-interaction-visual-language/02-04-SUMMARY.md`
</output>
