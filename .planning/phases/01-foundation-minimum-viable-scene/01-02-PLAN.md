---
phase: 01-foundation-minimum-viable-scene
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/components/odyssey-world/OdysseyWorld.tsx
  - src/components/odyssey-world/IsometricScene.tsx
  - src/components/odyssey-world/SceneLayer.tsx
  - src/components/odyssey-world/Platform.tsx
  - src/components/odyssey-world/Decoration.tsx
  - src/components/odyssey-world/LightSource.tsx
  - src/components/odyssey-world/OpticalElement.tsx
  - src/components/odyssey-world/Avatar.tsx
  - src/components/odyssey-world/HUD.tsx
  - src/components/odyssey-world/hooks/useIsometricCamera.ts
  - src/components/odyssey-world/hooks/useClickToMove.ts
  - src/pages/OdysseyPage.tsx
autonomous: true
requirements:
  - WRLD-01
  - WRLD-04
  - VISL-02
  - VISL-04
  - TECH-01
  - TECH-05

must_haves:
  truths:
    - "Student sees an illustrated isometric optical laboratory with platforms at multiple height levels"
    - "Student clicks on a location in the scene and the avatar/viewpoint moves there smoothly"
    - "Scene is slightly larger than viewport -- student can pan by moving and zoom with scroll wheel"
    - "Scene edges show faded silhouettes suggesting neighboring regions exist beyond"
    - "Interactive elements have subtle idle animations (pulsing, wobble) suggesting interactability"
    - "HUD overlay shows back button, minimap, and settings without obscuring the scene"
  artifacts:
    - path: "src/components/odyssey-world/OdysseyWorld.tsx"
      provides: "Root component orchestrating scene + HUD"
      min_lines: 40
    - path: "src/components/odyssey-world/IsometricScene.tsx"
      provides: "SVG viewport with camera transform and click handling"
      min_lines: 60
    - path: "src/components/odyssey-world/hooks/useClickToMove.ts"
      provides: "Click-to-move navigation with screen-to-world conversion"
      min_lines: 30
    - path: "src/components/odyssey-world/hooks/useIsometricCamera.ts"
      provides: "Camera pan/zoom with Framer Motion values"
      min_lines: 40
    - path: "src/components/odyssey-world/HUD.tsx"
      provides: "Semi-transparent overlay with back, minimap, settings"
      min_lines: 30
  key_links:
    - from: "src/components/odyssey-world/hooks/useClickToMove.ts"
      to: "src/lib/isometric.ts"
      via: "screenToWorldWithCamera for click coordinate conversion"
      pattern: "screenToWorldWithCamera"
    - from: "src/components/odyssey-world/hooks/useIsometricCamera.ts"
      to: "framer-motion"
      via: "useMotionValue for GPU-composited pan/zoom (no React re-renders)"
      pattern: "useMotionValue"
    - from: "src/components/odyssey-world/IsometricScene.tsx"
      to: "src/stores/odysseyWorldStore.ts"
      via: "reads sceneElements for rendering"
      pattern: "useOdysseyWorldStore"
    - from: "src/pages/OdysseyPage.tsx"
      to: "src/components/odyssey-world/OdysseyWorld.tsx"
      via: "replaces placeholder with actual world component"
      pattern: "import.*OdysseyWorld"
---

<objective>
Build the visual isometric scene with click-to-move navigation: the SVG laboratory illustration, multi-level platforms, decorative elements, optical element SVGs with idle animations, avatar movement, camera pan/zoom, HUD overlay, and distant region silhouettes at scene edges.

Purpose: This creates the "place" the student explores -- the illustrated isometric world that makes the experience feel like Monument Valley, not a demo viewport. Without the scene, there's nothing to navigate.
Output: Complete visual isometric scene at `/odyssey/` with click-to-navigate, zoom, and HUD.
</objective>

<execution_context>
@/Users/jili/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jili/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-minimum-viable-scene/01-CONTEXT.md
@.planning/phases/01-foundation-minimum-viable-scene/01-RESEARCH.md
@.planning/phases/01-foundation-minimum-viable-scene/01-01-SUMMARY.md

@src/lib/isometric.ts
@src/stores/odysseyWorldStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build isometric scene rendering with SVG layers and camera system</name>
  <files>
    src/components/odyssey-world/OdysseyWorld.tsx
    src/components/odyssey-world/IsometricScene.tsx
    src/components/odyssey-world/SceneLayer.tsx
    src/components/odyssey-world/Platform.tsx
    src/components/odyssey-world/Decoration.tsx
    src/components/odyssey-world/LightSource.tsx
    src/components/odyssey-world/OpticalElement.tsx
    src/components/odyssey-world/Avatar.tsx
    src/components/odyssey-world/hooks/useIsometricCamera.ts
    src/components/odyssey-world/hooks/useClickToMove.ts
    src/pages/OdysseyPage.tsx
  </files>
  <action>
Create the full isometric scene rendering system. This is the visual heart of the Odyssey experience.

**CRITICAL PERFORMANCE RULE (from Research pitfall 3):** Camera pan/zoom MUST use Framer Motion `useMotionValue` for position during animation, NOT React state. Apply camera offset via CSS `transform: translate()` on the SVG container. Only sync to Zustand on animation complete. This prevents 60 re-renders/second during pan.

**CRITICAL VISUAL RULE (from CONTEXT.md):** Bright, fresh color palette -- white/light background tones. Rich, multi-layered scene with decorative detail. Monument Valley quality bar. NOT dark room, NOT minimalist.

**File-by-file instructions:**

**`hooks/useIsometricCamera.ts`:**
- Export a hook that returns `{ cameraX, cameraY, zoom, svgTransform, handleWheel }`.
- `cameraX` and `cameraY` are Framer Motion `useMotionValue(0)` -- NOT React state.
- `zoom` is Framer Motion `useMotionValue(1)`.
- `svgTransform` is a `useTransform` that combines cameraX, cameraY, zoom into a CSS transform string: `translate(${-x * z}px, ${-y * z}px) scale(${z})`.
- `handleWheel` is a `useCallback` that adjusts zoom by `deltaY > 0 ? -0.1 : 0.1`, clamped with `clampZoom` from isometric.ts. Zoom toward cursor position (adjust camera offset so the point under the cursor stays fixed).
- On animation complete (when movement stops), sync `cameraX.get()`, `cameraY.get()` to the Zustand store via `useOdysseyWorldStore.getState().setCamera(...)`.

**`hooks/useClickToMove.ts`:**
- Export a hook `useClickToMove(cameraX: MotionValue, cameraY: MotionValue, zoom: MotionValue)`.
- Returns `{ handleSceneClick, avatarScreenX, avatarScreenY }`.
- On click: get click position relative to SVG element (`getBoundingClientRect()`), convert to world coordinates using `screenToWorldWithCamera` from isometric.ts, call `store.navigateTo(worldX, worldY)`.
- Animate cameraX and cameraY using `animate(cameraX, targetScreenX, { type: 'spring', stiffness: 80, damping: 18 })` to smoothly follow the avatar.
- `avatarScreenX` and `avatarScreenY` are derived MotionValues for the avatar's screen position (used by Avatar component).
- On animation complete, call `store.onNavigationComplete()`.

**`IsometricScene.tsx`:**
- The main SVG viewport component. Receives camera hooks.
- Renders a `<div>` container (full viewport, `overflow-hidden`) with a `<motion.div>` inside that has the camera CSS transform applied via `style={{ transform: svgTransform }}`.
- Inside the motion.div, renders a `<svg viewBox="0 0 2400 1600">` (scene is larger than viewport per user decision).
- SVG contains shared `<defs>` for beam glow filters (for Plan 03) and gradient definitions.
- Renders scene layers in painter's algorithm order using `<SceneLayer>`:
  - Layer 0: Background (warm gradient #FAFAF5 to #F0EDE6, faint isometric grid at 2% opacity, distant region silhouettes)
  - Layer 1: Platforms (isometric diamond shapes, depth-sorted by worldX + worldY)
  - Layer 2: Scene objects (optical elements, decorations, light source -- depth-sorted)
  - Layer 3: Beams (empty in this plan -- Plan 03 fills this)
  - Layer 4: Avatar + effects (avatar orb, click indicator)
- Attaches `onClick` to the SVG for click-to-move.
- Attaches `onWheel` via `useIsometricCamera`'s `handleWheel`.

**`SceneLayer.tsx`:**
- Simple wrapper: `<g>` element that depth-sorts its children by their `data-depth` attribute.
- Accept `elements` prop (array of SceneElement from store), sort by `depthSort(x, y, z)` from isometric.ts, render children in order.

**`Platform.tsx`:**
- Renders a single isometric platform as an SVG `<g>` positioned at `worldToScreen(worldX, worldY)`.
- The platform shape is an isometric diamond (4-point polygon): top, right, bottom, left vertices offset by TILE_WIDTH_HALF and TILE_HEIGHT_HALF.
- For Z > 0 platforms: add a side face (the "wall" visible from the front) for depth illusion.
- Color scheme: Ground level (Z=0) -- warm off-white (#F0EDE6) with subtle border. Raised (Z=1) -- slightly brighter (#F5F2EC) with gentle shadow below. Use clean geometric style.
- React.memo with stable key for performance.

**`Decoration.tsx`:**
- Renders non-interactive decorative elements (small objects, patterns, markers).
- Each decoration type has a simple SVG shape: `'plant'` (small green triangle cluster), `'crystal-display'` (geometric prism shape), `'lens-rack'` (horizontal bar with circles), `'measurement-dial'` (circle with tick marks).
- Subtle idle animation using Framer Motion: gentle floating motion (translateY oscillation, 3-4 second period).
- React.memo.

**`LightSource.tsx`:**
- Renders the light emitter as an SVG illustration. A bright, glowing circular/star shape with a soft halo.
- Idle animation: gentle pulsing (scale oscillation 0.95-1.05, 2s period) using Framer Motion `motion.g` with `animate={{ scale: [0.95, 1.05] }}` and `transition={{ repeat: Infinity, repeatType: 'reverse', duration: 2 }}`.
- Position using `worldToScreen(element.worldX, element.worldY)`.
- Self-luminous glow effect: a larger semi-transparent circle behind the main shape.

**`OpticalElement.tsx`:**
- Renders pre-placed optical elements (polarizer, waveplate) as SVG illustrations.
- NOT interactive in Phase 1 (no drag/rotate -- that's Phase 2 / deferred).
- Each element type has a distinct shape: `'polarizer'` (vertical rectangle with parallel lines/grooves), `'waveplate'` (rectangle with diagonal hatching pattern).
- Subtle idle animation: gentle wobble (rotate oscillation +/- 2 degrees, 4s period) to hint at future interactability per user decision.
- React.memo.

**`Avatar.tsx`:**
- A small glowing particle/orb (per research recommendation: "photon explorer" avatar).
- Rendered as a `<motion.circle>` with `r=6`, bright warm color (#FFD700), soft glow halo (larger circle at 30% opacity behind it).
- Position driven by `avatarScreenX` and `avatarScreenY` motion values from useClickToMove.
- Subtle idle animation when not moving: gentle breathing glow (opacity oscillation on the halo).

**`HUD.tsx`:**
- Semi-transparent overlay rendered as regular HTML (not SVG) on top of the scene.
- Position: absolute, z-index above the SVG scene.
- Elements:
  - **Back button** (top-left): lucide-react ArrowLeft icon, navigates to /demos/ or / via TanStack Router `useNavigate`.
  - **Minimap** (bottom-right): A small (120x80px) simplified version of the scene showing platform outlines and avatar position dot. Render as a tiny inline SVG.
  - **Settings** (top-right): lucide-react Settings icon (placeholder, no functionality yet).
- All HUD elements: semi-transparent background (bg-white/70 dark:bg-black/40), rounded, backdrop-blur. Use `cn()` for conditional Tailwind classes.
- HUD never obscures the main scene center.

**`OdysseyWorld.tsx`:**
- Root component that composes everything.
- Calls `useIsometricCamera()` and `useClickToMove(cameraX, cameraY, zoom)`.
- Reads `sceneElements` and `beamSegments` from `useOdysseyWorldStore`.
- Renders `<IsometricScene>` with all scene content + `<HUD>` overlay.
- Full viewport: `w-screen h-screen overflow-hidden` (no scrollbar).

**Distant region silhouettes (CONTEXT.md: scene edges):**
- In the background layer of IsometricScene, add 3-4 simple SVG silhouette shapes at the edges of the scene (e.g., faded building outlines to the left, crystal formations to the right, a misty landscape at the top).
- Very low opacity (10-15%), muted colors, positioned outside the walkable area.
- These are static decorative SVG groups -- no interaction, no animation.

**Update `src/pages/OdysseyPage.tsx`:**
- Replace the placeholder from Plan 01 with: `import { OdysseyWorld } from '@/components/odyssey-world/OdysseyWorld'` and render `<OdysseyWorld />`.
- Keep the `useEffect` that calls `initScene()` on mount.

**Background atmosphere (Claude discretion from CONTEXT.md):**
- Use a warm off-white gradient background: `<rect>` filling the SVG viewBox with a `<linearGradient>` from `#FAFAF5` (top) to `#F0EDE6` (bottom).
- Overlay a faint isometric grid pattern at 2% opacity (thin lines at isometric angles) to subtly communicate navigable space. The grid lines should be barely visible -- more felt than seen.
  </action>
  <verify>
Run `pnpm run build` -- zero errors. Open `/odyssey/` in dev server:
1. See an isometric laboratory scene with platforms, decorations, optical elements on a bright warm background
2. Click anywhere on a platform -- the avatar orb moves there smoothly with spring animation
3. Scroll wheel zooms in/out, scene transforms smoothly
4. HUD shows back button (top-left), minimap (bottom-right), settings icon (top-right)
5. Optical elements have subtle wobble animation, light source pulses, decorations float gently
6. Scene edges show faded silhouettes of neighboring regions
7. Check browser DevTools Performance: confirm no excessive React re-renders during camera pan (should see CSS transform changes, not React component updates)
8. Open DevTools console: no errors, no warnings about missing keys or invalid SVG
  </verify>
  <done>
A student opens /odyssey/ and sees a beautifully illustrated isometric optical laboratory with multi-level platforms, optical elements with subtle animations, decorative details, and a warm bright atmosphere. Clicking moves a glowing avatar to the clicked location with smooth spring animation. Scroll wheel zooms. HUD provides navigation controls without obscuring the scene. Scene edges show distant regions. Camera pan uses CSS transforms for 60fps performance.
  </done>
</task>

</tasks>

<verification>
1. `pnpm run build` succeeds
2. Isometric scene renders with platforms at Z=0 and Z=1 height levels
3. Click-to-move works: clicking a location moves the avatar there with spring animation
4. Scroll-wheel zoom works with clamping (0.5x to 2x)
5. Scene is larger than viewport -- panning reveals more content
6. HUD overlay visible but not obscuring scene center
7. Idle animations visible on optical elements (wobble), light source (pulse), decorations (float)
8. Scene edges show distant region silhouettes at low opacity
9. No console errors or warnings
10. 60fps during camera pan (check DevTools Performance)
</verification>

<success_criteria>
- Student sees a coherent illustrated isometric laboratory -- it looks like a PLACE, not a demo panel
- Click-to-move navigation works smoothly with spring physics
- Scene has depth: multi-level platforms, decorative elements, distant regions visible at edges
- Camera system uses Framer Motion values (not React state) for 60fps pan/zoom
- All SVG/CSS -- no Three.js, no WebGL, no Canvas (pure 2D-primary per VISL-04)
- Desktop-first: mouse click and scroll wheel are primary inputs
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-minimum-viable-scene/01-02-SUMMARY.md`
</output>
