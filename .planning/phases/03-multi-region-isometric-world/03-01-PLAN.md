---
phase: 03-multi-region-isometric-world
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/odysseyWorldStore.ts
  - src/components/odyssey-world/regions/regionRegistry.ts
  - src/components/odyssey-world/regions/crystalLab.ts
  - src/components/odyssey-world/regions/refractionBench.ts
  - src/components/odyssey-world/regions/scatteringChamber.ts
  - src/components/odyssey-world/regions/wavePlatform.ts
  - src/components/odyssey-world/regions/interfaceLab.ts
  - src/components/odyssey-world/regions/measurementStudio.ts
  - src/lib/isometric.ts
  - src/pages/OdysseyPage.tsx
autonomous: true
requirements:
  - WRLD-02
  - WRLD-06
  - DISC-06

must_haves:
  truths:
    - "Store manages 6 named regions with per-region scene elements, discoveries, and rotation history"
    - "All 6 regions are accessible from the start with no locked or gated regions"
    - "Returning student's discoveries, element positions, and camera state persist across browser sessions"
    - "Switching active region atomically swaps scene elements without stale state"
    - "Each region has a distinct color palette, grid size, and equipment palette"
  artifacts:
    - path: "src/components/odyssey-world/regions/regionRegistry.ts"
      provides: "RegionDefinition type, RegionTheme, RegionBoundary, 6 region configs, getRegionDefinition, getAllRegionIds"
      min_lines: 80
    - path: "src/stores/odysseyWorldStore.ts"
      provides: "Multi-region state (activeRegionId, regions Map, visitedRegions Set), persist middleware, switchRegion atomic action, resetRegion, initScene with hydration guard"
      contains: "persist"
    - path: "src/lib/isometric.ts"
      provides: "regionToWorld/worldToRegion coordinate utilities, region bounds checking"
      exports: ["regionToWorld", "worldToRegion", "getRegionBounds"]
  key_links:
    - from: "src/stores/odysseyWorldStore.ts"
      to: "src/components/odyssey-world/regions/regionRegistry.ts"
      via: "initScene loads region definitions from registry"
      pattern: "getRegionDefinition|getAllRegionIds"
    - from: "src/stores/odysseyWorldStore.ts"
      to: "localStorage"
      via: "Zustand persist middleware with custom Set/Map serialization"
      pattern: "persist.*createJSONStorage"
    - from: "src/pages/OdysseyPage.tsx"
      to: "src/stores/odysseyWorldStore.ts"
      via: "Hydration-aware initScene (onFinishHydration guard)"
      pattern: "onFinishHydration|persist"
---

<objective>
Build the multi-region data layer: define 6 interconnected optical laboratory regions with distinct themes, restructure the store for multi-region state management, and add session persistence via Zustand persist middleware.

Purpose: This is the foundation for all Phase 3 work. Every subsequent plan (transitions, beams, discoveries) depends on the region registry and multi-region store structure.

Output: Region registry with 6 RegionDefinitions, extended odysseyWorldStore with per-region state + persist middleware, coordinate utilities for multi-region layout, hydration-aware scene initialization.
</objective>

<execution_context>
@/Users/jili/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jili/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-multi-region-isometric-world/03-CONTEXT.md
@.planning/phases/03-multi-region-isometric-world/03-RESEARCH.md
@src/stores/odysseyWorldStore.ts
@src/lib/isometric.ts
@src/pages/OdysseyPage.tsx
@src/components/odyssey-world/hooks/useDiscoveryState.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create region registry with 6 RegionDefinition configs and coordinate utilities</name>
  <files>
    src/components/odyssey-world/regions/regionRegistry.ts
    src/components/odyssey-world/regions/crystalLab.ts
    src/components/odyssey-world/regions/refractionBench.ts
    src/components/odyssey-world/regions/scatteringChamber.ts
    src/components/odyssey-world/regions/wavePlatform.ts
    src/components/odyssey-world/regions/interfaceLab.ts
    src/components/odyssey-world/regions/measurementStudio.ts
    src/lib/isometric.ts
  </files>
  <action>
    **Create the region type system and 6 region configs.**

    In `regionRegistry.ts`, define these types:
    - `RegionTheme`: id, name (display), nameKey (i18n), colorPalette (background gradient stops, platformFill, platformStroke, accentColor), gridOpacity (0.01-0.04)
    - `RegionBoundary`: direction ('north'|'south'|'east'|'west'), targetRegionId, type ('soft'|'archway'|'tunnel'|'bridge'), entryPoint {x,y}, exitPoint {x,y}
    - `RegionDefinition`: id, theme, gridWidth (12-15), gridHeight (12-15), worldOffsetX, worldOffsetY, initialElements (SceneElement[]), paletteItems (SceneElementType[]), boundaries (RegionBoundary[]), discoveries (DiscoveryConfig[]), discoveryConnections (cross-region links)

    Export: `getRegionDefinition(id)`, `getAllRegionIds()`, `getRegionById(id)`, `REGION_DEFINITIONS` map.

    **6 region configs** (one file each, imported by registry):

    1. **crystalLab.ts** (13x13) -- Ice-blue palette. Physics: birefringence, half-wave rotation, circular polarization. This is the expanded Phase 1 scene. Keep ALL existing Phase 1 elements (light-source-1, polarizer-1, waveplate-1, decorations, environment-medium-1) at their current positions. Expand platforms from 7x7 to 13x13. Add ~5 new pre-placed optical elements (second polarizer, second waveplate, a prism). Palette: polarizer, waveplate, prism. Boundaries: south->refractionBench (soft), east->wavePlatform (archway). worldOffset: (0, 0).

    2. **refractionBench.ts** (15x12) -- Warm-orange palette. Physics: Brewster's angle, total internal reflection, Snell's law with polarization. Pre-placed: 2 light sources, 1 environment medium (glass), 1 polarizer. Palette: polarizer, environment. Boundaries: north->crystalLab (soft), east->scatteringChamber (tunnel), south->interfaceLab (bridge). worldOffset: (0, 15).

    3. **scatteringChamber.ts** (12x12) -- Deep-purple palette. Physics: Rayleigh scattering polarization, sky polarization. Pre-placed: 1 light source, environment medium (atmospheric). Palette: polarizer, waveplate. Boundaries: west->refractionBench (tunnel), south->measurementStudio (archway). worldOffset: (16, 15).

    4. **wavePlatform.ts** (15x13) -- Teal/cyan palette. Physics: wave interference, retardation, Jones vector concepts. Pre-placed: 1 light source, 2 waveplates at different retardations. Palette: waveplate, polarizer, prism. Boundaries: west->crystalLab (archway), south->measurementStudio (soft). worldOffset: (14, 0).

    5. **interfaceLab.ts** (13x13) -- Green-gold palette. Physics: Fresnel reflection, interface polarization effects. Pre-placed: 1 light source, 2 environment mediums (glass, water). Palette: polarizer, environment. Boundaries: north->refractionBench (bridge), east->measurementStudio (soft). worldOffset: (0, 28).

    6. **measurementStudio.ts** (14x14) -- Silver-gray palette. Physics: Stokes measurement, polarimetry techniques. Pre-placed: 1 light source, 1 polarizer, 1 waveplate. Palette: polarizer, waveplate, prism. Boundaries: north->scatteringChamber (archway), north->wavePlatform (soft), west->interfaceLab (soft). worldOffset: (14, 28).

    Each region generates its own platform grid (like createInitialSceneElements but for gridWidth x gridHeight). Element IDs use region prefix: `{regionId}-platform-{x}-{y}`, `{regionId}-light-source-1`, etc.

    Per-region equipment palettes vary per CONTEXT.md: "different regions offer different optical elements in their palette."

    **All 6 regions freely accessible** -- no unlock logic, no gates in boundary definitions.

    **Coordinate utilities in isometric.ts:**
    Add `regionToWorld(localX, localY, regionDef)` and `worldToRegion(worldX, worldY, regionDef)` that apply worldOffset. Add `getRegionBounds(regionDef)` returning {minX, maxX, minY, maxY} in world coordinates. Keep all existing functions unchanged.

    **Discovery configs per region:** Define 3-5 discovery configurations per region (similar to Phase 2's discoveryConfigurations in useDiscoveryState.ts). Each has id, name, check function, and response type. Import the existing DiscoveryConfig pattern. For the Crystal Lab, keep the existing 5 discoveries from Phase 2 and add 1-2 new ones.

    Use Chinese comments for physics logic, English for technical docs, per CLAUDE.md.
  </action>
  <verify>
    `pnpm run build` succeeds (no type errors). Import regionRegistry in a test file and verify `getAllRegionIds()` returns 6 IDs, each `getRegionDefinition(id)` returns a valid config with non-empty initialElements and boundaries.
  </verify>
  <done>
    6 RegionDefinition configs exist with distinct themes, grid sizes (12x12 to 15x15), physics concepts, and equipment palettes. Crystal Lab preserves all Phase 1 elements expanded to 13x13. All regions have boundary definitions connecting to adjacent regions with no unlock/gate logic. Coordinate utilities handle region-to-world translation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Restructure store for multi-region state with Zustand persist middleware</name>
  <files>
    src/stores/odysseyWorldStore.ts
    src/pages/OdysseyPage.tsx
  </files>
  <action>
    **Extend odysseyWorldStore.ts for multi-region state management and session persistence.**

    Add to OdysseyWorldState interface:
    - `activeRegionId: string` (default: 'crystal-lab')
    - `regions: Map<string, RegionState>` where RegionState holds: elements, beamSegments, discoveries (Set), discoveredEncodings, rotationHistory (Map), incomingBeams (BoundaryBeam[])
    - `visitedRegions: Set<string>` (tracks which regions the student has entered)
    - `isTransitioning: boolean` (blocks interactions during region switch)
    - `transitionTarget: string | null`
    - `worldMapOpen: boolean`

    Add new actions:
    - `switchRegion(regionId, entryPoint?)` -- **ATOMIC single set() call** that: (1) saves current active region state to regions Map, (2) loads target region state from regions Map, (3) updates activeRegionId, avatarX, avatarY, clears beamSegments (useBeamPhysics will recalculate). Per research pitfall 4, this MUST be a single set() to prevent stale state in physics hooks.
    - `saveActiveRegion()` -- saves current sceneElements, beamSegments, discoveries, encodings, rotationHistory to regions Map under activeRegionId
    - `loadRegion(regionId)` -- loads a region's state from regions Map into active working set
    - `resetRegion(regionId)` -- resets a region to its initial state from regionRegistry, without affecting other regions
    - `setTransitioning(isTransitioning, target)` -- sets transition state
    - `markRegionVisited(regionId)` -- adds to visitedRegions Set
    - `toggleWorldMap()` -- toggles worldMapOpen

    **Wrap store creation with Zustand `persist` middleware:**
    - Import `persist, createJSONStorage` from `zustand/middleware`
    - Create custom storage object with getItem/setItem/removeItem that handles Set->Array and Map->entries serialization/deserialization (per research Pattern 4)
    - Use `partialize` to persist ONLY: activeRegionId, regions, visitedRegions, achievedDiscoveries, discoveredEncodings, avatarX, avatarY, cameraX, cameraY, zoom. Exclude transient UI state: isTransitioning, transitionTarget, worldMapOpen, isMoving, navigationTarget, dragPreviewPos, hoveredElementId, interactionMode, selectedElementId, environmentPopupTarget.
    - Set `name: 'odyssey-world-v3'`, `version: 1`
    - Middleware order: `subscribeWithSelector(persist(...))`

    **Update initScene():**
    - Use `onRehydrateStorage` callback pattern from research pitfall 1
    - If persist hydrates successfully (saved state found), set sceneLoaded=true and skip initialization
    - If no saved state found, initialize all 6 regions from regionRegistry, set Crystal Lab as active region, populate the active working set from Crystal Lab's initial elements
    - Cap rotationHistory to 20 entries per element during deserialization to prevent unbounded growth (per research pitfall 3)

    **Update OdysseyPage.tsx:**
    - Replace the existing `useEffect(() => { initScene() }, [])` with hydration-aware pattern:
    ```
    useEffect(() => {
      const unsub = useOdysseyWorldStore.persist.onFinishHydration(() => {
        if (!useOdysseyWorldStore.getState().sceneLoaded) {
          useOdysseyWorldStore.getState().initScene()
        }
      })
      // Also handle case where hydration already completed (fast localStorage)
      if (useOdysseyWorldStore.persist.hasHydrated()) {
        if (!useOdysseyWorldStore.getState().sceneLoaded) {
          useOdysseyWorldStore.getState().initScene()
        }
      }
      return unsub
    }, [])
    ```

    **Keep ALL existing actions and state fields.** This is an extension, not a replacement. All Phase 2 hooks (useElementDrag, useElementRotation, useElementSelection, useBeamPhysics, useDiscoveryState) must continue to work by reading/writing sceneElements and beamSegments as before.

    All interaction hooks must early-return when `isTransitioning` is true (add this check in a later plan when transitions are wired -- for now, just add the state field).
  </action>
  <verify>
    `pnpm run build` succeeds. The store initializes with 6 regions. `switchRegion` atomically swaps active scene elements. Refreshing the browser restores the previous session state (activeRegionId, element positions, discoveries).
  </verify>
  <done>
    Store manages 6 regions with per-region state. Persist middleware serializes Set/Map types to localStorage under 'odyssey-world-v3'. Hydration-aware initScene prevents overwriting saved state. switchRegion is atomic. All Phase 2 hooks continue to work with no changes.
  </done>
</task>

</tasks>

<verification>
1. `pnpm run build` -- zero TypeScript errors, clean build
2. Open /odyssey/ in browser -- scene loads (Crystal Lab as default active region)
3. Place an element, rotate it, close browser, reopen -- element position and rotation persist
4. Check localStorage for 'odyssey-world-v3' key -- contains serialized state
5. Call `useOdysseyWorldStore.getState().switchRegion('refraction-bench', {x: 7, y: 0})` from console -- sceneElements changes to Refraction Bench elements, activeRegionId updates
6. All Phase 2 interactions (drag, rotate, select, popup, discovery) still work in Crystal Lab
</verification>

<success_criteria>
- 6 distinct region definitions with unique themes, grid sizes, physics concepts, and equipment palettes
- All regions freely accessible (no lock/gate logic anywhere)
- Store persist middleware saves and restores full session state across browser sessions
- Atomic region switching prevents stale beam physics
- Phase 1 scene preserved and expanded as Crystal Lab region
</success_criteria>

<output>
After completion, create `.planning/phases/03-multi-region-isometric-world/03-01-SUMMARY.md`
</output>
