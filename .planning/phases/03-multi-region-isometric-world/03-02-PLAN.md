---
phase: 03-multi-region-isometric-world
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/odyssey-world/OdysseyWorld.tsx
  - src/components/odyssey-world/IsometricScene.tsx
  - src/components/odyssey-world/RegionTransition.tsx
  - src/components/odyssey-world/hooks/useRegionTransition.ts
  - src/components/odyssey-world/regions/RegionDecorations.tsx
  - src/components/odyssey-world/regions/CrystalLabDecorations.tsx
  - src/components/odyssey-world/regions/RefractionBenchDecorations.tsx
  - src/components/odyssey-world/regions/ScatteringChamberDecorations.tsx
  - src/components/odyssey-world/regions/WavePlatformDecorations.tsx
  - src/components/odyssey-world/regions/InterfaceLabDecorations.tsx
  - src/components/odyssey-world/regions/MeasurementStudioDecorations.tsx
  - src/components/odyssey-world/Avatar.tsx
  - src/components/odyssey-world/Platform.tsx
  - src/components/odyssey-world/HUD.tsx
  - src/components/odyssey-world/hooks/useClickToMove.ts
autonomous: true
requirements:
  - WRLD-03
  - WRLD-05

must_haves:
  truths:
    - "Student can walk to a region edge or click an entrance object and smoothly transition to the adjacent region"
    - "Region transitions animate as smooth camera slides (~0.8-1.2s) with a brief region name title card overlay"
    - "Avatar fades out at the exit point, then reappears at the entry point of the new region"
    - "First-time entry into a region has a special slower reveal animation"
    - "Region decoration SVGs load lazily without blocking the initial bundle"
    - "All interactions are blocked during transitions -- no clicks or drags register"
    - "Element positions placed by the student persist when leaving and returning to a region"
  artifacts:
    - path: "src/components/odyssey-world/hooks/useRegionTransition.ts"
      provides: "Region transition orchestration: boundary detection, camera slide animation, avatar teleport"
      min_lines: 60
    - path: "src/components/odyssey-world/RegionTransition.tsx"
      provides: "Region name title card overlay with AnimatePresence"
      min_lines: 30
    - path: "src/components/odyssey-world/regions/RegionDecorations.tsx"
      provides: "React.lazy dispatcher for per-region decoration components with Suspense"
      min_lines: 20
  key_links:
    - from: "src/components/odyssey-world/hooks/useRegionTransition.ts"
      to: "src/stores/odysseyWorldStore.ts"
      via: "Calls switchRegion atomic action, reads isTransitioning"
      pattern: "switchRegion|setTransitioning"
    - from: "src/components/odyssey-world/hooks/useRegionTransition.ts"
      to: "src/components/odyssey-world/hooks/useClickToMove.ts"
      via: "Boundary detection triggers transition when avatar walks near region edge"
      pattern: "initiateTransition|onNavigationComplete"
    - from: "src/components/odyssey-world/regions/RegionDecorations.tsx"
      to: "React.lazy"
      via: "Dynamic import of per-region decoration SVGs"
      pattern: "React\\.lazy|import\\("
---

<objective>
Implement region transitions and lazy-loaded region rendering: smooth animated camera slides between regions, region name title cards, avatar fade/teleport, boundary detection triggering transitions, lazy-loaded per-region decoration SVGs, interaction blocking during transitions, and first-entry reveal animations.

Purpose: This gives students the experience of moving between distinct optical laboratory environments -- the core exploration mechanic of the multi-region world.

Output: Working region transitions triggered by walking to boundaries or clicking entrances, with smooth animations, title cards, and lazy-loaded decorations.
</objective>

<execution_context>
@/Users/jili/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jili/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-multi-region-isometric-world/03-CONTEXT.md
@.planning/phases/03-multi-region-isometric-world/03-RESEARCH.md
@.planning/phases/03-multi-region-isometric-world/03-01-SUMMARY.md
@src/components/odyssey-world/OdysseyWorld.tsx
@src/components/odyssey-world/IsometricScene.tsx
@src/components/odyssey-world/Avatar.tsx
@src/components/odyssey-world/hooks/useClickToMove.ts
@src/components/odyssey-world/hooks/useIsometricCamera.ts
@src/components/odyssey-world/HUD.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build region transition hook, boundary detection, and transition overlay</name>
  <files>
    src/components/odyssey-world/hooks/useRegionTransition.ts
    src/components/odyssey-world/RegionTransition.tsx
    src/components/odyssey-world/hooks/useClickToMove.ts
    src/components/odyssey-world/Avatar.tsx
    src/components/odyssey-world/OdysseyWorld.tsx
  </files>
  <action>
    **Create useRegionTransition.ts hook:**

    This hook orchestrates region transitions. It accepts the camera MotionValues (cameraX, cameraY, zoom) and avatar MotionValues (avatarScreenX, avatarScreenY) from useIsometricCamera/useClickToMove.

    `initiateTransition(targetRegionId, entryPoint)` does:
    1. Guard: if store.isTransitioning, return immediately
    2. `store.setTransitioning(true, targetRegionId)`
    3. Wait ~200ms for avatar fade-out (Avatar component reacts to isTransitioning)
    4. Call `store.switchRegion(targetRegionId, entryPoint)` -- atomic region swap
    5. Set avatar MotionValues to the entry point screen position via worldToScreen
    6. Calculate camera target to center the entry point in the viewport (same math as useClickToMove centering logic)
    7. Animate camera with `animate(cameraX, target, springConfig)` and `animate(cameraY, target, springConfig)`:
       - Normal entry: stiffness 60, damping 20 (~1.0s)
       - First entry (check `!store.visitedRegions.has(targetRegionId)`): stiffness 40, damping 18 (~1.5s), also animate zoom from 0.8 to 1.0 for a reveal arc effect
    8. `store.setTransitioning(false, null)`
    9. `store.markRegionVisited(targetRegionId)`
    10. Sync camera to store: `store.setCamera(cameraX.get(), cameraY.get())`

    Also export `checkBoundaryProximity(avatarX, avatarY, activeRegionId)`:
    - Gets active region definition from registry
    - Checks if avatar position is within 0.5 grid units of any boundary exitPoint
    - If yes, returns `{ boundary, targetRegionId, entryPoint }` -- otherwise null
    - This is called after each navigation completes

    **Modify useClickToMove.ts:**
    - After `onNavigationComplete()` fires (avatar reached target), call `checkBoundaryProximity` with the new avatar position
    - If boundary detected, call `initiateTransition` with the target region and entry point
    - Add early return at the top of the click handler if `store.isTransitioning` is true

    **Also support explicit entrance clicks:** In OdysseyWorld.tsx or IsometricScene.tsx, detect clicks on decoration elements with `properties.entranceType` matching a boundary type ('archway', 'tunnel', 'bridge'). On click, find the matching boundary and call `initiateTransition`. This allows both walk-to-edge (soft) AND click-entrance (hard) triggers per CONTEXT.md.

    **Create RegionTransition.tsx:**
    - Region name title card overlay using Framer Motion AnimatePresence
    - Watches `isTransitioning` and `transitionTarget` from store
    - When transitioning starts, shows the target region's theme.name in large, light text centered on screen
    - Title card fades in over 0.3s, stays for ~1.5s, fades out over 0.3s
    - First entry: title stays 0.5s longer (2.0s total)
    - Use `pointer-events-none` on the overlay container
    - During transition, also render a semi-transparent overlay behind the title card (`bg-black/10`) with pointer-events-all to block scene interactions

    **Modify Avatar.tsx:**
    - Read `isTransitioning` from store
    - When isTransitioning becomes true, animate avatar opacity to 0 over 200ms
    - When isTransitioning becomes false, animate avatar opacity from 0 to 1 over 300ms
    - Use Framer Motion animate() on the avatar SVG group's opacity

    **Wire into OdysseyWorld.tsx:**
    - Call `useRegionTransition(cameraX, cameraY, zoom, avatarScreenX, avatarScreenY)`
    - Render `<RegionTransition />` component
    - Pass `initiateTransition` to IsometricScene or interaction handlers where entrance click detection needs it

    All interaction hooks (useElementDrag, useElementRotation, useElementSelection) must check `store.isTransitioning` and return early. Add this check at the top of each pointer event handler in those hooks (per research pitfall 2). This prevents clicks/drags during the ~1s transition window.
  </action>
  <verify>
    `pnpm run build` succeeds. Walking the avatar to a region boundary triggers a smooth camera slide to the adjacent region with title card. Avatar fades out and reappears. Clicking during transition does nothing. First entry has a slower, zoom-arc reveal.
  </verify>
  <done>
    Students can move between regions by walking to edges (soft boundaries) or clicking entrances (hard boundaries). Camera slides smoothly (~1.0s normal, ~1.5s first entry), region name appears as title card, avatar fades and teleports, all interactions blocked during transition. Element positions persist across visits.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement lazy-loaded region decorations and dynamic scene rendering</name>
  <files>
    src/components/odyssey-world/regions/RegionDecorations.tsx
    src/components/odyssey-world/regions/CrystalLabDecorations.tsx
    src/components/odyssey-world/regions/RefractionBenchDecorations.tsx
    src/components/odyssey-world/regions/ScatteringChamberDecorations.tsx
    src/components/odyssey-world/regions/WavePlatformDecorations.tsx
    src/components/odyssey-world/regions/InterfaceLabDecorations.tsx
    src/components/odyssey-world/regions/MeasurementStudioDecorations.tsx
    src/components/odyssey-world/IsometricScene.tsx
    src/components/odyssey-world/Platform.tsx
    src/components/odyssey-world/HUD.tsx
  </files>
  <action>
    **Create per-region decoration components (6 files):**

    Each `{Region}Decorations.tsx` is a React component that renders SVG group elements specific to that region's visual atmosphere. These are non-interactive scenery (lab equipment illustrations, background patterns, geometric motifs).

    Each decoration component:
    - Receives `gridWidth`, `gridHeight`, and `theme` as props
    - Renders 5-10 SVG elements (rectangles, circles, paths) that create the region's visual identity
    - Uses the region's `colorPalette.accentColor` and related colors
    - Positioned using `worldToScreen` for consistent isometric placement
    - Chinese comments explaining what each decoration represents in the lab context

    **Decoration themes by region:**
    1. CrystalLabDecorations: Ice-blue crystal formations, hexagonal patterns, frost-like edge decorations, glass specimen cases
    2. RefractionBenchDecorations: Warm-orange workbench surfaces, calibration rulers, curved lens outlines, refraction angle diagrams etched on floor
    3. ScatteringChamberDecorations: Deep-purple atmospheric haze (gradient circles), particle traces, telescope silhouettes, sky dome indicators
    4. WavePlatformDecorations: Teal wave interference patterns (overlapping circles), phase markers, harmonic grid lines
    5. InterfaceLabDecorations: Green-gold interface boundary lines, Fresnel curve outlines, stacked material slabs
    6. MeasurementStudioDecorations: Silver-gray detector outlines, measurement scales, Stokes parameter readout placeholders, calibration charts

    Keep decorations lightweight -- each file should be 40-80 lines of SVG elements. No animations in decorations (those belong to the beam layer per VISL-03).

    **Create RegionDecorations.tsx (lazy loader):**
    - Use `React.lazy()` to dynamically import each decoration component:
      ```
      const decorationComponents = {
        'crystal-lab': React.lazy(() => import('./CrystalLabDecorations')),
        'refraction-bench': React.lazy(() => import('./RefractionBenchDecorations')),
        // ...etc
      }
      ```
    - Export a `RegionDecorationsLoader` component that takes `regionId`, `gridWidth`, `gridHeight`, `theme` and renders the appropriate lazy component inside `<Suspense>` with a simple SVG skeleton fallback (light gray platform outlines)
    - On region entry, preload adjacent region decorations using dynamic `import()` calls (per research Pattern 6): `preloadAdjacentRegions(regionId)` iterates the region's boundaries and triggers dynamic imports for each target region

    **Update IsometricScene.tsx:**
    - Read `activeRegionId` and the active region's theme from store/registry
    - Apply the region's colorPalette: set background gradient, platform fill/stroke colors, grid opacity
    - Replace the current static `DistantSilhouettes` component (or equivalent) with the `RegionDecorationsLoader` component
    - Render decorations in the scene layer between platforms and objects (L1.5 conceptually)
    - Adjust SVG viewBox to accommodate larger region sizes (up to 15x15): viewBox should be calculated based on the active region's gridWidth/gridHeight using worldToScreen for the bounding box, with padding. Consider increasing from the current 2400x1600 to a dynamically calculated size, or keep it large enough for the maximum region size

    **Update Platform.tsx:**
    - Accept theme color overrides from the active region's theme
    - Platform fill color comes from `region.theme.colorPalette.platformFill`
    - Platform stroke color comes from `region.theme.colorPalette.platformStroke`
    - Default to current values if no theme override (backward compatible)

    **Update HUD.tsx:**
    - Show the active region name somewhere in the HUD (small text, top-left or near minimap)
    - Show a minimap button that opens the world map (will be implemented in Plan 03, but add the button now with `store.toggleWorldMap()`)
    - Minimap should show the active region's simplified outline rather than just the single-region view
  </action>
  <verify>
    `pnpm run build` succeeds. Each region has visually distinct decorations and platform colors. Switching regions changes the scene's visual atmosphere. Network tab shows decoration chunks loading on demand (not all upfront). Build output shows separate chunks for each decoration file.
  </verify>
  <done>
    6 region decoration components render unique SVG scenery per region. React.lazy splits them into separate chunks. Adjacent regions preload on entry. IsometricScene dynamically applies region theme colors. Platforms render with per-region color palettes. HUD shows active region name and world map button.
  </done>
</task>

</tasks>

<verification>
1. `pnpm run build` -- zero TypeScript errors, clean build with separate chunks for decoration files
2. Open /odyssey/ -- Crystal Lab loads with its decorations and ice-blue theme
3. Walk avatar to south edge of Crystal Lab -- triggers smooth transition to Refraction Bench with warm-orange theme and title card "Refraction Bench"
4. Click an archway decoration in Crystal Lab east boundary -- triggers transition to Wave Platform
5. First entry into a new region shows slower reveal animation with zoom arc
6. Return to Crystal Lab -- elements are where you left them, Crystal Lab decorations reload instantly (cached)
7. Check browser Network tab -- decoration chunks load on demand, not all at once
8. During transition, clicking/dragging in the scene does nothing
</verification>

<success_criteria>
- Smooth animated transitions between all 6 regions via edge walking and entrance clicking
- Region name title card displays during each transition
- Avatar fade-out/fade-in at transition points
- First-entry reveal animation distinguishable from repeat entries
- Per-region visual themes (color palettes, decorations) render correctly
- Decoration SVGs lazy-load per region (separate Vite chunks)
- All interactions blocked during transition window
</success_criteria>

<output>
After completion, create `.planning/phases/03-multi-region-isometric-world/03-02-SUMMARY.md`
</output>
