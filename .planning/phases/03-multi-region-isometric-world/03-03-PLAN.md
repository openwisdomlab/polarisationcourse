---
phase: 03-multi-region-isometric-world
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - src/components/odyssey-world/hooks/useBeamPhysics.ts
  - src/components/odyssey-world/hooks/useBoundaryBeams.ts
  - src/components/odyssey-world/hooks/useDiscoveryConnections.ts
  - src/components/odyssey-world/hooks/useWorldMap.ts
  - src/components/odyssey-world/hooks/useDiscoveryState.ts
  - src/components/odyssey-world/BoundaryIndicator.tsx
  - src/components/odyssey-world/DiscoveryConnection.tsx
  - src/components/odyssey-world/WorldMap.tsx
  - src/components/odyssey-world/IsometricScene.tsx
  - src/components/odyssey-world/OdysseyWorld.tsx
  - src/components/odyssey-world/ElementPalette.tsx
  - src/lib/isometric.ts
  - src/components/odyssey-world/regions/regionRegistry.ts
autonomous: true
requirements:
  - PHYS-04
  - DISC-02
  - DISC-05

must_haves:
  truths:
    - "A light beam reaching a region boundary shows a pulsing glow indicator at the edge"
    - "Entering an adjacent region shows the beam arriving from the corresponding boundary with its Stokes parameters preserved"
    - "A discovery in one region triggers a visible connection cue in a related region"
    - "The world map shows all 6 regions with visited/unvisited state and discovery connections"
    - "Students can fast-travel to any visited region from the world map"
    - "Equipment palette shows different elements per region and enriches as discoveries are made"
    - "Cross-region big discoveries require combining knowledge from multiple regions"
  artifacts:
    - path: "src/components/odyssey-world/hooks/useBoundaryBeams.ts"
      provides: "Boundary beam detection, BoundaryBeam record creation, storage in store"
      min_lines: 40
    - path: "src/components/odyssey-world/BoundaryIndicator.tsx"
      provides: "SVG pulsing gradient at region boundary edges showing beam continuation"
      min_lines: 30
    - path: "src/components/odyssey-world/WorldMap.tsx"
      provides: "HTML overlay world map with 6 region shapes, visited state, discovery connections, fast-travel"
      min_lines: 80
    - path: "src/components/odyssey-world/hooks/useDiscoveryConnections.ts"
      provides: "Cross-region discovery link tracking, connection activation on discovery achievement"
      min_lines: 40
    - path: "src/components/odyssey-world/DiscoveryConnection.tsx"
      provides: "SVG faint glowing lines between connected discovery points in the scene"
      min_lines: 30
  key_links:
    - from: "src/components/odyssey-world/hooks/useBoundaryBeams.ts"
      to: "src/components/odyssey-world/hooks/useBeamPhysics.ts"
      via: "Reads calculated beamSegments, detects boundary exits via clipBeamToRegion"
      pattern: "beamSegments|clipBeamToRegion|BoundaryBeam"
    - from: "src/components/odyssey-world/hooks/useDiscoveryConnections.ts"
      to: "src/components/odyssey-world/regions/regionRegistry.ts"
      via: "Reads discoveryConnections from region definitions"
      pattern: "discoveryConnections|getRegionDefinition"
    - from: "src/components/odyssey-world/WorldMap.tsx"
      to: "src/stores/odysseyWorldStore.ts"
      via: "Reads visitedRegions, achievedDiscoveries; calls switchRegion for fast-travel"
      pattern: "visitedRegions|switchRegion|worldMapOpen"
    - from: "src/components/odyssey-world/ElementPalette.tsx"
      to: "src/stores/odysseyWorldStore.ts"
      via: "Reads activeRegionId to determine palette items, enriches based on discoveries"
      pattern: "activeRegionId|paletteItems|achievedDiscoveries"
---

<objective>
Implement cross-region physics and discovery systems: beam boundary propagation with visual indicators, cross-region discovery connections with in-scene and map visualization, a constellation-style world map with fast-travel, and knowledge-gated equipment palette enrichment.

Purpose: This brings the 6 regions to life as an interconnected world -- beams flow across boundaries, discoveries in one region illuminate concepts in others, and the world map reveals the growing knowledge graph.

Output: Boundary beam indicators, cross-region discovery visual cues, world map overlay with fast-travel, enriched equipment palettes, and cross-region "big discoveries."
</objective>

<execution_context>
@/Users/jili/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jili/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-multi-region-isometric-world/03-CONTEXT.md
@.planning/phases/03-multi-region-isometric-world/03-RESEARCH.md
@.planning/phases/03-multi-region-isometric-world/03-01-SUMMARY.md
@.planning/phases/03-multi-region-isometric-world/03-02-SUMMARY.md
@src/components/odyssey-world/hooks/useBeamPhysics.ts
@src/components/odyssey-world/hooks/useDiscoveryState.ts
@src/components/odyssey-world/ElementPalette.tsx
@src/components/odyssey-world/IsometricScene.tsx
@src/components/odyssey-world/OdysseyWorld.tsx
@src/lib/isometric.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement cross-region beam boundary detection and visual indicators</name>
  <files>
    src/components/odyssey-world/hooks/useBoundaryBeams.ts
    src/components/odyssey-world/hooks/useBeamPhysics.ts
    src/components/odyssey-world/BoundaryIndicator.tsx
    src/components/odyssey-world/IsometricScene.tsx
    src/lib/isometric.ts
  </files>
  <action>
    **Add boundary beam detection utilities to isometric.ts:**

    Add `clipBeamToRegion(fromX, fromY, toX, toY, regionBounds)`:
    - Returns `{ clippedToX, clippedToY, exits: boolean, exitDirection: 'north'|'south'|'east'|'west' }`
    - Uses parametric line-rectangle clipping (see research code example) to find where a beam segment exits the region bounds
    - If toX/toY is within bounds, returns `{ exits: false }` with original coordinates
    - If the beam exits, returns the intersection point and the exit direction

    **Create useBoundaryBeams.ts hook:**

    Define `BoundaryBeam` interface:
    ```
    interface BoundaryBeam {
      exitDirection: 'north' | 'south' | 'east' | 'west'
      exitPoint: { x: number; y: number }
      stokes: { s0: number; s1: number; s2: number; s3: number }
      direction: { dx: number; dy: number }
      sourceRegionId: string
    }
    ```

    The hook:
    - Reads `beamSegments` and `activeRegionId` from store
    - Gets the active region's bounds via `getRegionBounds(getRegionDefinition(activeRegionId))`
    - For each beam segment, checks if it exits the region bounds using `clipBeamToRegion`
    - If exits: creates a `BoundaryBeam` record with the exit point, the beam's Stokes parameters at that segment, and the propagation direction
    - Stores boundary beams on the adjacent region's `incomingBeams` array in the store (via a new action `updateBoundaryBeams(regionId, beams)`)
    - Returns current region's boundary beams for rendering indicators
    - Also reads current region's `incomingBeams` and returns them for rendering incoming beam indicators

    **Extend useBeamPhysics.ts:**
    - At the start of beam path calculation, check if the active region has `incomingBeams`
    - If yes, treat each incoming beam as an additional beam source: it starts at the boundary entry point with the carried Stokes parameters and propagation direction
    - The existing `calculateBeamPath` logic handles the rest -- it will apply whatever optical elements are in the beam's path within this region
    - This means a beam from Crystal Lab that enters Refraction Bench will interact with Refraction Bench's elements, producing different polarization behavior per PHYS-04

    **Create BoundaryIndicator.tsx:**
    - SVG component rendered at boundary exit/entry points
    - Visual: a pulsing gradient fade -- the beam color (derived from Stokes parameters via `polarizationToVisual`) gradually becomes a soft glow extending to the boundary edge
    - Animation: subtle pulse (opacity oscillates between 0.4 and 0.8 over 2s) using CSS animation (not Framer Motion, to keep beam layer lightweight per Phase 1 pattern)
    - Exit indicators: "beam continues here" -- positioned at exitPoint, glow extends toward boundary direction
    - Entry indicators: "beam arrives here" -- positioned at incoming beam entry point, glow extends inward from boundary
    - Use the same SVG filter approach as beam-glow but with lower stdDeviation (1.0) so it doesn't compete with the main beam per VISL-03

    **Wire into IsometricScene.tsx:**
    - Call `useBoundaryBeams()` in the scene
    - Render `<BoundaryIndicator>` components for each exit beam and each incoming beam
    - Place indicators in the beam layer (same group as LightBeam components, between objects and avatar)
    - Only render when not transitioning (`!isTransitioning`)
  </action>
  <verify>
    `pnpm run build` succeeds. Place elements in Crystal Lab so a beam reaches the south boundary -- a pulsing glow appears at the edge. Switch to Refraction Bench -- the beam appears entering from the north boundary. The beam interacts with Refraction Bench's optical elements (different polarization behavior).
  </verify>
  <done>
    Beams reaching region boundaries produce pulsing glow indicators at exit points. Adjacent regions receive incoming beam records. When entering an adjacent region, beams arrive from the boundary with preserved Stokes parameters and interact with the local optical elements, exhibiting different polarization phenomena per region.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build discovery connections and knowledge-gated equipment palettes</name>
  <files>
    src/components/odyssey-world/hooks/useDiscoveryConnections.ts
    src/components/odyssey-world/hooks/useDiscoveryState.ts
    src/components/odyssey-world/DiscoveryConnection.tsx
    src/components/odyssey-world/ElementPalette.tsx
    src/components/odyssey-world/regions/regionRegistry.ts
  </files>
  <action>
    **Define cross-region discovery connections in regionRegistry.ts:**

    Add to each RegionDefinition's `discoveryConnections` array. Each connection links a discovery in one region to a related discovery in another region:

    ```
    interface DiscoveryConnectionDef {
      fromDiscoveryId: string  // Discovery in this region
      toRegionId: string       // Connected region
      toDiscoveryId: string    // Connected discovery in the other region
      connectionTag: string    // Human-readable "why they connect" (for constellation map tooltip)
    }
    ```

    Define ~15-20 hand-curated connections across the 6 regions. Examples:
    - Crystal Lab "malus-law" <-> Refraction Bench "brewster-angle" (both involve cos^2 intensity relationships)
    - Crystal Lab "circular-polarization" <-> Wave Platform "quarter-wave-retardation" (both involve 90-degree phase shifts)
    - Refraction Bench "total-internal-reflection" <-> Interface Lab "fresnel-reflection" (both involve interface angle dependence)
    - Scattering Chamber "rayleigh-scattering" <-> Measurement Studio "stokes-measurement" (sky polarization measurement)

    Also define 3-4 "big discoveries" (meta-discoveries) that require combining discoveries from 2-3 regions:
    - "Wave-Particle Duality of Polarization": Requires discoveries in Crystal Lab + Wave Platform + Measurement Studio
    - "Universal Interface Law": Requires discoveries in Refraction Bench + Interface Lab
    - "Complete Polarization Control": Requires discoveries in Crystal Lab + Wave Platform + Refraction Bench
    These are stored as a separate `META_DISCOVERIES` array with `requiredDiscoveries: { regionId, discoveryId }[]` and a special response animation.

    **Create useDiscoveryConnections.ts hook:**
    - Reads `achievedDiscoveries` from store (global, not per-region)
    - Reads all `discoveryConnections` from all region definitions
    - Computes `activeConnections`: connections where the `fromDiscoveryId` has been achieved
    - When a new discovery is achieved, checks if any new connections become active
    - For meta-discoveries: checks if all required discoveries are achieved; if so, fires a special "big discovery" event (stored as a special discovery ID in `achievedDiscoveries`)
    - Returns: `activeConnections` for the current region (filtered to connections involving the active region), `metaDiscoveries` (achieved meta-discovery IDs), `allConnections` (for world map)

    **Update useDiscoveryState.ts:**
    - After `achieveDiscovery` is called, also trigger `useDiscoveryConnections`'s connection check
    - The discovery configs now come from the active region's definition (from regionRegistry) instead of the hardcoded array
    - Keep backward compatibility: the Crystal Lab's discoveries include all existing Phase 2 discoveries
    - Each region's discovery configs are defined in its region definition file

    **Create DiscoveryConnection.tsx:**
    - SVG component rendered in the scene showing faint glowing lines/particles between connected discovery points
    - For each active connection in the current region: draw a faint dotted line (stroke-dasharray 4,8) from the discovery point to the region boundary, with a subtle animated pulse
    - Use very low opacity (0.15-0.25) and thin stroke (1px) so it doesn't compete with the beam (VISL-03)
    - When a NEW connection activates (discovery just made), briefly flash brighter (0.6 opacity for 1.5s) then fade to subtle
    - Position discovery points at the worldToScreen coordinates of the optical element associated with each discovery

    **Update ElementPalette.tsx for knowledge-gated enrichment:**

    Per DISC-02: "Knowledge-gated progression -- student advances through understanding, gating is invisible (not locked doors, but enriched palettes)."

    - Read `activeRegionId` from store to get the region's base `paletteItems`
    - Read `achievedDiscoveries` from store
    - Define a `PALETTE_ENRICHMENTS` map: certain discoveries unlock additional palette items in certain regions
      - Example: Discovering "circular-polarization" in Crystal Lab adds waveplate to Refraction Bench's palette
      - Example: Discovering "brewster-angle" in Refraction Bench adds environment to Wave Platform's palette
      - ~10 enrichment rules total
    - The palette renders base items + any enriched items where the required discovery is achieved
    - No visible "locked" state -- items simply appear as discoveries are made. This is the invisible gating per DISC-02.
    - The palette still uses the existing diegetic shelf visual style from Phase 2

    Wire DiscoveryConnection into IsometricScene.tsx in the L2.5 layer (between objects and beam, same as DiscoveryFeedback).
  </action>
  <verify>
    `pnpm run build` succeeds. Make a discovery in Crystal Lab -- a faint connection line appears toward a region boundary. Navigate to the connected region -- the connection indicator is visible. ElementPalette shows different items per region. After a discovery, a new palette item appears in another region.
  </verify>
  <done>
    Cross-region discovery connections render as subtle in-scene visual cues. ~15-20 hand-curated connections plus 3-4 meta-discoveries span the 6 regions. Equipment palettes show per-region items with invisible discovery-based enrichment. Discovery configs come from region definitions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Build constellation-style world map with fast-travel and discovery overlay</name>
  <files>
    src/components/odyssey-world/WorldMap.tsx
    src/components/odyssey-world/hooks/useWorldMap.ts
    src/components/odyssey-world/OdysseyWorld.tsx
  </files>
  <action>
    **Create useWorldMap.ts hook:**
    - Reads from store: `worldMapOpen`, `visitedRegions`, `activeRegionId`, `achievedDiscoveries`
    - Reads from useDiscoveryConnections: `allConnections`, `metaDiscoveries`
    - `open()` / `close()` toggle world map via `store.toggleWorldMap()`
    - `fastTravel(regionId)`: if region is in `visitedRegions`, calls `close()` then `initiateTransition(regionId, defaultEntryPoint)` -- the default entry point is the first boundary's entryPoint from the current region to the target, or the center of the target region if not directly adjacent
    - Returns: region layout data for rendering, connection lines, visited/unvisited status

    **Create WorldMap.tsx:**
    - HTML overlay (not SVG in the scene) -- `fixed inset-0 z-40` with semi-transparent dark backdrop (`bg-black/50`)
    - Renders as a Framer Motion AnimatePresence component (fades in/out)
    - **Region shapes:** 6 abstract polygons (rounded rectangles or hexagons) arranged in the spatial layout matching the region adjacency. Each shape uses the region's `colorPalette.accentColor`:
      - Visited regions: filled with accent color at 0.6 opacity
      - Unvisited regions: outlined with accent color at 0.3 opacity, gray fill
      - Active region: filled with accent color at 0.8 opacity, subtle pulse border
    - **Region labels:** Region name below each shape, smaller font
    - **Boundary lines:** Thin lines connecting adjacent region shapes, color based on boundary type (soft: dotted, archway/tunnel/bridge: solid)
    - **Discovery connections:** Glowing dotted lines between specific points within region shapes, using a bright accent color (gold/white). Only shown for achieved connections. These form the "constellation" pattern.
    - **Meta-discovery indicators:** Special star/burst icons at the intersection of connection lines for achieved meta-discoveries
    - **Discovery progress:** Small text showing "N/M discoveries" per region
    - **Fast-travel:** Clicking a visited region shape calls `fastTravel(regionId)`. Unvisited regions are not clickable (but still visible -- per WRLD-06 all regions are accessible, but fast-travel requires having visited once; walking there is always possible).
    - **Close:** Click backdrop or press Escape to close

    Per research pitfall 5: keep the map lightweight. Use simple colored shapes, no actual scene elements or glow filters. Discovery connection lines are plain SVG `<line>` elements.

    Per CONTEXT.md: "The world map doubles as a progress tracker -- students can see which regions they've explored and which discoveries remain."

    **Layout algorithm:** Position the 6 region shapes in a grid matching the spatial layout:
    ```
    Row 0: Crystal Lab (0,0) | Wave Platform (1,0)
    Row 1: Refraction Bench (0,1) | Scattering Chamber (1,1)
    Row 2: Interface Lab (0,2) | Measurement Studio (1,2)
    ```
    Scale to fit the overlay viewport with padding.

    **Wire into OdysseyWorld.tsx:**
    - Render `<WorldMap />` component
    - HUD world map button (from Plan 02) toggles `store.toggleWorldMap()`
    - Press 'M' key also toggles world map (keyboard shortcut)
  </action>
  <verify>
    `pnpm run build` succeeds. Press 'M' or click world map button -- map overlay appears with 6 region shapes. Current region highlighted. Click a visited region -- fast-travel transition triggers. Discovery connections shown as constellation lines between regions. Close with Escape or clicking backdrop.
  </verify>
  <done>
    Constellation-style world map overlay shows all 6 regions with visited/unvisited state, discovery connections, and meta-discovery indicators. Students can fast-travel to any visited region by clicking its shape. Map serves as both navigation and progress tracker. Keyboard shortcut 'M' toggles the map.
  </done>
</task>

</tasks>

<verification>
1. `pnpm run build` -- zero TypeScript errors
2. In Crystal Lab, arrange elements so a beam reaches the south boundary -- pulsing glow appears at edge
3. Transition to Refraction Bench -- beam arrives from north boundary, interacts with Refraction Bench elements differently
4. Make "malus-law" discovery in Crystal Lab -- faint connection line appears toward south boundary
5. Navigate to Refraction Bench -- connection indicator visible for related "brewster-angle" discovery
6. Open world map (press M) -- 6 regions visible, Crystal Lab and Refraction Bench marked as visited
7. Click Crystal Lab on world map -- fast-travel back to Crystal Lab
8. Check ElementPalette in Refraction Bench before/after making discoveries -- new items appear
9. Achieve all required discoveries for a meta-discovery -- special big discovery animation fires
10. World map shows constellation connection lines between regions with discoveries
</verification>

<success_criteria>
- Cross-region beam propagation works: beam exits one region, enters adjacent region with preserved Stokes parameters, interacts with local elements
- Boundary indicators pulse at exit/entry points without overpowering the main beam
- Discovery connections render as subtle in-scene cues and constellation lines on the world map
- World map shows all 6 regions with fast-travel to visited regions
- Equipment palettes enriched by discoveries (invisible gating)
- 3-4 meta-discoveries reward cross-region exploration
</success_criteria>

<output>
After completion, create `.planning/phases/03-multi-region-isometric-world/03-03-SUMMARY.md`
</output>
